<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Complaint Letter Writing - Task 1 Assessment | GK Foundation</title>
    
    <!-- Font Awesome CSS (Embedded for self-contained operation) -->
    <style>
        /* Font Awesome 6.4.0 - Core icons embedded for self-contained operation */
        .fas, .far, .fab {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands";
            font-weight: 900;
            font-style: normal;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Core icons used in this page */
        .fa-pen:before { content: "\f304"; }
        .fa-check-circle:before { content: "\f058"; }
        .fa-exclamation-triangle:before { content: "\f071"; }
        .fa-star:before { content: "\f005"; }
        .fa-clock:before { content: "\f017"; }
        .fa-bars:before { content: "\f0c9"; }
        .fa-times:before { content: "\f00d"; }
        .fa-chevron-right:before { content: "\f054"; }
        .fa-chevron-left:before { content: "\f053"; }
        .fa-book-open:before { content: "\f518"; }
        .fa-chart-bar:before { content: "\f080"; }
        .fa-graduation-cap:before { content: "\f19d"; }
        .fa-lightbulb:before { content: "\f0eb"; }
        .fa-file-alt:before { content: "\f15c"; }
        .fa-trophy:before { content: "\f091"; }
        .fa-sync:before { content: "\f021"; }
        .fa-download:before { content: "\f019"; }
        .fa-cog:before { content: "\f013"; }
        .fa-search:before { content: "\f002"; }
        .fa-info-circle:before { content: "\f05a"; }
        .fa-bug:before { content: "\f188"; }
        .fa-spell-check:before { content: "\f891"; }
        .fa-font:before { content: "\f031"; }
        .fa-palette:before { content: "\f53f"; }
        .fa-brain:before { content: "\f5dc"; }
        .fa-users:before { content: "\f0c0"; }
        .fa-language:before { content: "\f1ab"; }
        .fa-tools:before { content: "\f7d9"; }
        .fa-eye:before { content: "\f06e"; }
        .fa-medal:before { content: "\f5a2"; }
        .fa-tasks:before { content: "\f0ae"; }
        .fa-clipboard-list:before { content: "\f46d"; }
        .fa-comments:before { content: "\f086"; }
        .fa-filter:before { content: "\f0b0"; }
        .fa-flag:before { content: "\f024"; }
        .fa-heart:before { content: "\f004"; }
        .fa-rocket:before { content: "\f135"; }
        .fa-certificate:before { content: "\f0a3"; }
    </style>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(139, 69, 19, 0.2) 50%, rgba(255, 215, 0, 0.1) 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.05) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Header spacing - minimal top margin for professional appearance */
        .header-spacer {
            height: 20px;
            width: 100%;
        }

        /* Guruvammal Logo as Back Button - Right Side */
        .gk-logo-container {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .gk-logo-container:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .master-guruvammal-logo {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            box-sizing: border-box;
            font-family: 'Century Gothic', sans-serif;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: -1px;
            line-height: 1;
            color: #5d3a0a;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(139, 69, 19, 0.25) 50%, rgba(205, 133, 63, 0.2) 100%);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3), 0 0 40px rgba(212, 175, 55, 0.2);
            z-index: 10000;
            transition: all 0.3s ease;
        }

        .master-guruvammal-logo .musical-corner {
            position: absolute;
            top: 3px;
            right: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: transparent;
            border: 1px solid #5d3a0a;
            color: #5d3a0a;
            font-family: 'Century Gothic', sans-serif;
            font-size: 7px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
            box-shadow: none;
        }

        .master-guruvammal-logo:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.4), 0 0 50px rgba(212, 175, 55, 0.3);
        }

        .foundation-text {
            font-size: 1rem;
            font-weight: bold;
            color: #8b4513;
            font-family: 'Century Gothic', sans-serif;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        /* Back Label under Logo */
        .back-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #8b4513;
            font-family: 'Century Gothic', sans-serif;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            text-align: center;
            transition: all 0.3s ease;
        }

        .gk-logo-container:hover .back-label {
            color: #5d3a0a;
            transform: translateY(-1px);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            margin-left: 400px; /* Aligned with slideout menu width */
            transition: margin-left 0.3s ease;
        }

        .container.menu-collapsed {
            margin-left: 20px; /* Clean minimal spacing when collapsed */
        }

        /* Main Content - professional layout */
        .main-content {
            margin-top: 0;
            padding: 1.5rem 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Slide-out Menu Button */
        .menu-toggle {
            position: fixed;
            top: 30px;
            left: 400px;
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 0.8rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            z-index: 1001;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Menu Toggle Label */
        .menu-toggle-label {
            position: fixed;
            top: 85px;
            left: 422px;
            background: rgba(139, 69, 19, 0.9);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.3);
            z-index: 1001;
            transition: all 0.3s ease;
            min-width: 45px;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .menu-toggle:hover {
            background: linear-gradient(135deg, #a0522d, #8b4513);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
        }

        .menu-toggle:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .menu-toggle:hover + .menu-toggle-label {
            background: rgba(160, 82, 45, 0.95);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.4);
        }

        .menu-toggle.collapsed {
            left: 20px;
        }

        .menu-toggle-label.collapsed {
            left: 42px;
        }

        /* Slide-out Menu */
        .slide-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 390px; /* Wider for detailed analysis */
            height: 100vh;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(25px);
            box-shadow: 4px 0 24px rgba(212, 175, 55, 0.15);
            border-right: 2px solid rgba(212, 175, 55, 0.15);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding-top: 20px;
        }

        .slide-menu::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.02) 0%, rgba(212, 175, 55, 0.03) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .slide-menu.collapsed {
            left: -390px;
        }

        .menu-header {
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            padding: 2rem 1.5rem 1.2rem 1.5rem;
            text-align: center;
            position: relative;
            z-index: 2;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 70px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        .menu-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .menu-subtitle {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .menu-content {
            padding: 1.2rem 1.2rem;
            position: relative;
            z-index: 2;
        }

        .menu-section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: #8b4513;
            margin-bottom: 0.8rem;
            padding: 0.5rem 0;
            border-bottom: 2px solid rgba(139, 69, 19, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            font-size: 1rem;
            color: #d4af37;
        }

        .menu-item {
            display: block;
            padding: 0.8rem 0.8rem;
            margin-bottom: 0.5rem;
            background: rgba(139, 69, 19, 0.05);
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            border-left: 3px solid #8b4513;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(139, 69, 19, 0.08);
            font-size: 0.85rem;
        }

        .menu-item:hover {
            background: rgba(139, 69, 19, 0.12);
            transform: translateX(3px);
            box-shadow: 0 3px 8px rgba(139, 69, 19, 0.15);
            border-left-color: #d4af37;
        }

        .item-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin: 0;
            color: #2c1810;
            letter-spacing: 0.2px;
        }

        .item-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-new {
            background: #28a745;
            color: white;
        }

        .badge-analysis {
            background: #007bff;
            color: white;
        }

        .badge-score {
            background: #ffc107;
            color: #000;
        }

        /* Hero Section - Writing Interface */
        .hero-section {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.2);
            padding: 2rem 2.5rem;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.03) 0%, rgba(212, 175, 55, 0.05) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 0.8rem;
            position: relative;
            z-index: 2;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.8);
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 2;
            font-weight: 500;
        }

        /* Writing Interface */
        .writing-interface {
            position: relative;
            z-index: 2;
        }

        .prompt-section {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .prompt-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 0.8rem;
        }

        .prompt-options {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .prompt-option {
            padding: 1rem;
            background: rgba(139, 69, 19, 0.08);
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .prompt-option:hover {
            background: rgba(139, 69, 19, 0.12);
            border-color: rgba(139, 69, 19, 0.3);
        }

        .prompt-option.selected {
            background: rgba(139, 69, 19, 0.15);
            border-color: #8b4513;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
        }

        .writing-area {
            margin-bottom: 1.5rem;
        }

        .writing-textarea {
            width: 100%;
            min-height: 300px;
            padding: 1.2rem;
            border: 2px solid rgba(139, 69, 19, 0.3);
            border-radius: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            resize: vertical;
            transition: all 0.3s ease;
        }

        .writing-textarea:focus {
            outline: none;
            border-color: #8b4513;
            box-shadow: 0 0 15px rgba(139, 69, 19, 0.2);
            background: rgba(255, 255, 255, 0.98);
        }

        .writing-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .word-count {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            opacity: 0.6;
        }

        .analyze-btn:enabled {
            opacity: 1;
        }

        .analyze-btn:enabled:hover {
            background: linear-gradient(135deg, #a0522d, #8b4513);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
        }

        .analyze-btn:disabled {
            cursor: not-allowed;
        }

        /* Small Timer Display (like reading practice) */
        .small-timer-display {
            position: fixed;
            top: -5px;
            right: 30px;
            z-index: 1003;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.95) 0%, rgba(212, 175, 55, 0.95) 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .small-timer-time {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .small-timer-display.warning {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.95) 0%, rgba(192, 57, 43, 0.95) 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Timer Start Container (Below subtitle, centered) */
        .timer-start-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            padding: 0.5rem;
        }

        .timer-start-btn {
            background: linear-gradient(135deg, #d4af37, #b8860b);
            color: white;
            border: none;
            padding: 1rem 2.2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 650;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
            letter-spacing: 0.3px;
        }

        .timer-start-btn:hover {
            background: linear-gradient(135deg, #ffd700, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(212, 175, 55, 0.4);
        }

        /* Content Sections for Analysis Results */
        .content-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 2rem;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            display: none; /* Hidden by default */
        }

        .content-section.active {
            display: block;
        }

        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.02) 0%, rgba(212, 175, 55, 0.03) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid rgba(139, 69, 19, 0.1);
            position: relative;
            z-index: 2;
        }

        .section-icon {
            font-size: 1.8rem;
            color: #d4af37;
            margin-right: 1rem;
        }

        .section-title-main {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8b4513;
            margin: 0;
        }

        .section-content {
            position: relative;
            z-index: 2;
        }

        /* Analysis Cards */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analysis-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
            border-left: 4px solid #8b4513;
            transition: all 0.3s ease;
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.15);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c1810;
            margin-bottom: 0.5rem;
        }

        .card-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        /* Error Details */
        .error-details {
            margin-top: 1.5rem;
        }

        .error-category {
            background: rgba(139, 69, 19, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #8b4513;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .category-name {
            font-weight: 600;
            color: #8b4513;
            font-size: 1rem;
        }

        .category-count {
            background: #8b4513;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 3px solid #d4af37;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Score Cards */
        .score-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .score-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.15);
            border: 2px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s ease;
        }

        .score-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.2);
        }

        .score-label {
            font-size: 1rem;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 0.8rem;
        }

        .score-value {
            font-size: 3rem;
            font-weight: bold;
            color: #2c1810;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .score-range {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        /* Feedback Section */
        .feedback-section {
            background: rgba(139, 69, 19, 0.05);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .feedback-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #8b4513;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-content {
            line-height: 1.6;
            color: #333;
        }

        .feedback-category {
            margin-bottom: 1.2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }

        .feedback-category h4 {
            color: #8b4513;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        /* Loading Animation */
        .loading-animation {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(139, 69, 19, 0.2);
            border-top: 4px solid #8b4513;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #8b4513;
            font-weight: 600;
        }

        /* Error Modal Styles */
        .error-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .error-modal-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 12px;
            width: 85%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .error-modal-header {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .error-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .error-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .error-modal-body {
            padding: 1.5rem;
            max-height: calc(80vh - 100px);
            overflow-y: auto;
        }

        .error-message {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #495057;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .copy-error-btn, .close-error-btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .copy-error-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .copy-error-btn:hover {
            background: linear-gradient(135deg, #0056b3, #003d82);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .close-error-btn {
            background: linear-gradient(135deg, #6c757d, #545b62);
            color: white;
        }

        .close-error-btn:hover {
            background: linear-gradient(135deg, #545b62, #3d4449);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .copy-error-btn i {
            margin-right: 0.5rem;
        }

        /* Mobile responsiveness for error modal */
        @media (max-width: 768px) {
            .error-modal-content {
                margin: 2% auto;
                width: 95%;
                max-width: none;
                max-height: 90vh;
            }

            .error-modal-header {
                padding: 0.8rem 1rem;
            }

            .error-modal-header h3 {
                font-size: 1rem;
            }

            .error-modal-close {
                font-size: 1.3rem;
                width: 22px;
                height: 22px;
            }

            .error-modal-body {
                padding: 1rem;
                max-height: calc(90vh - 80px);
            }

            .error-message {
                font-size: 0.75rem;
                max-height: 150px;
                padding: 0.8rem;
            }

            .error-actions {
                flex-direction: column;
                gap: 0.6rem;
            }

            .copy-error-btn, .close-error-btn {
                width: 100%;
                padding: 0.8rem;
                font-size: 0.8rem;
            }

            /* Timer mobile responsiveness */
            .small-timer-display {
                top: -3px;
                right: 15px;
                padding: 3px 6px;
                font-size: 0.75rem;
                min-width: 55px;
            }
            
            .small-timer-time {
                font-size: 0.75rem;
            }

            .timer-start-container {
                margin: 0.8rem 0;
                padding: 0.3rem;
            }

            .timer-start-btn {
                font-size: 1rem;
                padding: 0.8rem 1.8rem;
                border-radius: 8px;
            }

            .writing-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .word-count {
                text-align: center;
                font-size: 0.85rem;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin-left: 20px;
                padding: 0 1rem;
            }

            .slide-menu {
                width: 100%;
                left: -100%;
            }

            .slide-menu.collapsed {
                left: -100%;
            }

            .menu-toggle {
                left: 20px;
            }

            .menu-toggle-label {
                left: 42px;
            }

            .hero-title {
                font-size: 2rem;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .score-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .gk-logo-container {
                top: 20px;
                right: 20px;
            }

            .gk-logo {
                width: 40px;
                height: 40px;
            }

            .gk-logo .letters {
                font-size: 16px;
                width: 32px;
                height: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Spacer -->
    <div class="header-spacer"></div>

    <!-- Small Timer Display (like reading practice) -->
    <div class="small-timer-display" id="timerDisplay">
        <div class="small-timer-time">20:00</div>
    </div>

    <!-- Guruvammal Logo as Back Button -->
    <div class="gk-logo-container" onclick="window.location.href='IELTS_General_Writing_Introduction.html'">
        <div class="master-guruvammal-logo">
                            Ga<span class="musical-corner">P</span>
        </div>
        <div class="back-label">Back</div>
    </div>

    <!-- Error Modal -->
    <div class="error-modal" id="errorModal">
        <div class="error-modal-content">
            <div class="error-modal-header">
                <h3>Error Occurred</h3>
                <button class="error-modal-close" onclick="closeErrorModal()">&times;</button>
            </div>
            <div class="error-modal-body">
                <div class="error-message" id="errorMessageText"></div>
                <div class="error-actions">
                    <button class="copy-error-btn" onclick="copyErrorMessage()">
                        <i class="fas fa-copy"></i> Copy Error Message
                    </button>
                    <button class="close-error-btn" onclick="closeErrorModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide-out Menu Toggle Button -->
    <div class="menu-toggle collapsed" id="menuToggle">
        <i class="fas fa-bars"></i>
    </div>
    <div class="menu-toggle-label collapsed" id="menuToggleLabel">Analysis</div>

    <!-- Slide-out Menu -->
    <div class="slide-menu collapsed" id="slideMenu">
        <div class="menu-header">
            <div class="menu-title">
                Writing Analysis
            </div>
            <div class="menu-subtitle">Professional Assessment Dashboard</div>
        </div>
        
        <div class="menu-content">
            <!-- Quick Overview Section -->
            <div class="menu-section">
                <div class="section-title">
                    Quick Overview
                </div>
                <div class="menu-item" onclick="navigateToSection('overview')">
                    <div class="item-title">Analysis Summary<span class="item-badge badge-new">Live</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('scores')">
                    <div class="item-title">Band Scores<span class="item-badge badge-score">IELTS/CLB</span></div>
                </div>
            </div>

            <!-- Error Analysis Section -->
            <div class="menu-section">
                <div class="section-title">
                    Error Analysis
                </div>
                <div class="menu-item" onclick="navigateToSection('grammar-errors')">
                    <div class="item-title">Grammar Issues<span class="item-badge badge-analysis" id="grammar-count">0</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('spelling-errors')">
                    <div class="item-title">Spelling Mistakes<span class="item-badge badge-analysis" id="spelling-count">0</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('punctuation-errors')">
                    <div class="item-title">Punctuation<span class="item-badge badge-analysis" id="punctuation-count">0</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('style-issues')">
                    <div class="item-title">Style & Tone<span class="item-badge badge-analysis" id="style-count">0</span></div>
                </div>
            </div>

            <!-- Text Quality Section -->
            <div class="menu-section">
                <div class="section-title">
                    Text Quality
                </div>
                <div class="menu-item" onclick="navigateToSection('readability')">
                    <div class="item-title">Readability Analysis<span class="item-badge badge-analysis">Complexity</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('vocabulary')">
                    <div class="item-title">Vocabulary Assessment<span class="item-badge badge-analysis">Advanced</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('sentence-structure')">
                    <div class="item-title">Sentence Structure<span class="item-badge badge-analysis">Length</span></div>
                </div>
            </div>

            <!-- Detailed Metrics Section -->
            <div class="menu-section">
                <div class="section-title">
                    Detailed Metrics
                </div>
                <div class="menu-item" onclick="navigateToSection('error-rates')">
                    <div class="item-title">Error Rates<span class="item-badge badge-analysis">Per 100</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('severity-analysis')">
                    <div class="item-title">Severity Breakdown<span class="item-badge badge-analysis">H/M/L</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('category-distribution')">
                    <div class="item-title">Error Categories<span class="item-badge badge-analysis">11 Types</span></div>
                </div>
            </div>

            <!-- Technical Details Section -->
            <div class="menu-section">
                <div class="section-title">
                    Technical Details
                </div>
                <div class="menu-item" onclick="navigateToSection('suggestions')">
                    <div class="item-title">Correction Suggestions<span class="item-badge badge-analysis">Auto</span></div>
                </div>
            </div>

            <!-- Professional Feedback Section -->
            <div class="menu-section">
                <div class="section-title">
                    Professional Feedback
                </div>
                <div class="menu-item" onclick="navigateToSection('improvement-areas')">
                    <div class="item-title">Improvement Areas<span class="item-badge badge-new">Priority</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('writing-tips')">
                    <div class="item-title">Writing Tips<span class="item-badge badge-new">Targeted</span></div>
                </div>
                <div class="menu-item" onclick="navigateToSection('score-factors')">
                    <div class="item-title">Score Explanation<span class="item-badge badge-score">Factors</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container menu-collapsed" id="container">
        <div class="main-content">
            <!-- Hero Section - Writing Interface -->
            <div class="hero-section">
                <h1 class="hero-title">
                    IELTS Complaint Letter Writing Assessment
                </h1>
                <p class="hero-subtitle">Task 1 - Professional complaint letter analysis powered by Ga Server</p>
                
                <!-- Timer Start Button (Below subtitle, centered) -->
                <div class="timer-start-container">
                    <button class="timer-start-btn" id="startTimerBtn" onclick="startTimer()">
                        <i class="fas fa-play"></i> Start
                    </button>
                </div>
                
                <div class="writing-interface">
                    <!-- Writing Prompts -->
                    <div class="prompt-section">
                        <h3 class="prompt-title">Complaint Letter Writing Task:</h3>
                        <div class="prompt-options">
                            <div class="prompt-option" onclick="selectPrompt(this, 0)">
                                <strong>Restaurant Service Complaint:</strong> "You went to a restaurant last night with your family to celebrate a special occasion, but you were not satisfied with the service. Write a letter to the restaurant manager. In your letter: describe what occasion you were celebrating, explain what went wrong with the service, and say what you would like the manager to do about it."
                            </div>
                        </div>
                    </div>

                    <!-- Writing Area -->
                    <div class="writing-area">
                        <textarea 
                            id="writingText" 
                            class="writing-textarea" 
                            placeholder="Start writing your complaint letter here... (Minimum 150 words for IELTS Task 1). STRUCTURE: Describe the problem clearly → Explain impact/consequences → State what action you want. Be firm but polite, provide specific details, avoid emotional language. Choose appropriate greeting based on whether you know the recipient's name. Submit button will be enabled once you reach the 150 words limit."
                            oninput="updateWordCount()"
                            spellcheck="false"
                            autocorrect="off"
                            autocapitalize="off"
                        ></textarea>
                    </div>

                    <!-- Controls -->
                    <div class="writing-controls">
                        <div class="word-count" id="wordCount">Words: 0 | Characters: 0 | Required: 150+</div>
                        <button class="analyze-btn" id="analyzeBtn" onclick="analyzeWriting()" disabled>
                            Submit
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Animation -->
            <div class="loading-animation" id="loadingAnimation">
                <div class="loading-spinner"></div>
                <div class="loading-text">Connecting to Ga Server... Please wait...</div>
            </div>

            <!-- Analysis Overview Section -->
            <div class="content-section" id="overview-section">
                <div class="section-header">
                    <h2 class="section-title-main">Analysis Overview</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="overview-grid">
                        <!-- Analysis cards will be populated here -->
                    </div>
                    <div class="feedback-section">
                        <h3 class="feedback-title">
                            <i class="fas fa-lightbulb"></i>
                            Analysis Summary
                        </h3>
                        <div class="feedback-content" id="analysis-summary">
                            Complete your writing and click "Submit" to see comprehensive feedback.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scores Section -->
            <div class="content-section" id="scores-section">
                <div class="section-header">
                    <h2 class="section-title-main">Band Scores</h2>
                </div>
                <div class="section-content">
                    <div class="score-container" id="score-container">
                        <!-- Score cards will be populated here -->
                    </div>
                    <div class="feedback-section">
                        <h3 class="feedback-title">
                            <i class="fas fa-medal"></i>
                            Score Explanation
                        </h3>
                        <div class="feedback-content" id="score-explanation">
                            Band scores will be calculated based on comprehensive analysis factors.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grammar Errors Section -->
            <div class="content-section" id="grammar-errors-section">
                <div class="section-header">
                    <h2 class="section-title-main">Grammar Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="error-details" id="grammar-details">
                        <!-- Grammar error details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Spelling Errors Section -->
            <div class="content-section" id="spelling-errors-section">
                <div class="section-header">
                    <h2 class="section-title-main">Spelling Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="error-details" id="spelling-details">
                        <!-- Spelling error details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Punctuation Errors Section -->
            <div class="content-section" id="punctuation-errors-section">
                <div class="section-header">
                    <h2 class="section-title-main">Punctuation Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="error-details" id="punctuation-details">
                        <!-- Punctuation error details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Style Issues Section -->
            <div class="content-section" id="style-issues-section">
                <div class="section-header">
                    <h2 class="section-title-main">Style & Tone Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="error-details" id="style-details">
                        <!-- Style error details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Readability Section -->
            <div class="content-section" id="readability-section">
                <div class="section-header">
                    <h2 class="section-title-main">Readability Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="readability-grid">
                        <!-- Readability analysis will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Vocabulary Section -->
            <div class="content-section" id="vocabulary-section">
                <div class="section-header">
                    <h2 class="section-title-main">Vocabulary Assessment</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="vocabulary-grid">
                        <!-- Vocabulary analysis will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sentence Structure Section -->
            <div class="content-section" id="sentence-structure-section">
                <div class="section-header">
                    <h2 class="section-title-main">Sentence Structure Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="sentence-grid">
                        <!-- Sentence structure analysis will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Error Rates Section -->
            <div class="content-section" id="error-rates-section">
                <div class="section-header">
                    <h2 class="section-title-main">Error Rates Analysis</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="error-rates-grid">
                        <!-- Error rates analysis will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Severity Analysis Section -->
            <div class="content-section" id="severity-analysis-section">
                <div class="section-header">
                    <h2 class="section-title-main">Severity Breakdown</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="severity-grid">
                        <!-- Severity analysis will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Category Distribution Section -->
            <div class="content-section" id="category-distribution-section">
                <div class="section-header">
                    <h2 class="section-title-main">Error Category Distribution</h2>
                </div>
                <div class="section-content">
                    <div class="analysis-grid" id="category-grid">
                        <!-- Category distribution will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Ga Server Response Section -->
            <div class="content-section" id="api-response-section">
                <div class="section-header">
                    <i class="fas fa-code section-icon"></i>
                    <h2 class="section-title-main">Ga Server Response</h2>
                </div>
                <div class="section-content">
                    <div class="feedback-section">
                        <h3 class="feedback-title">
                            <i class="fas fa-server"></i>
                            Raw Ga Server Data
                        </h3>
                        <div class="feedback-content" id="api-data">
                            <!-- Ga Server response data will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rule Matches Section -->
            <div class="content-section" id="rule-matches-section">
                <div class="section-header">
                    <i class="fas fa-list-ul section-icon"></i>
                    <h2 class="section-title-main">Detailed Rule Matches</h2>
                </div>
                <div class="section-content">
                    <div class="error-details" id="rule-matches-details">
                        <!-- Rule matches will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Suggestions Section -->
            <div class="content-section" id="suggestions-section">
                <div class="section-header">
                    <h2 class="section-title-main">Correction Suggestions</h2>
                </div>
                <div class="section-content">
                    <div class="error-details" id="suggestions-details">
                        <!-- Suggestions will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Improvement Areas Section -->
            <div class="content-section" id="improvement-areas-section">
                <div class="section-header">
                    <h2 class="section-title-main">Priority Improvement Areas</h2>
                </div>
                <div class="section-content">
                    <div class="feedback-section">
                        <h3 class="feedback-title">
                            <i class="fas fa-bullseye"></i>
                            Recommended Focus Areas
                        </h3>
                        <div class="feedback-content" id="improvement-content">
                            <!-- Improvement recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Writing Tips Section -->
            <div class="content-section" id="writing-tips-section">
                <div class="section-header">
                    <h2 class="section-title-main">Targeted Writing Tips</h2>
                </div>
                <div class="section-content">
                    <div class="feedback-section">
                        <h3 class="feedback-title">
                            <i class="fas fa-graduation-cap"></i>
                            Writing Improvement Tips
                        </h3>
                        <div class="feedback-content" id="tips-content">
                            <!-- Writing tips will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Score Factors Section -->
            <div class="content-section" id="score-factors-section">
                <div class="section-header">
                    <h2 class="section-title-main">Score Factor Explanation</h2>
                </div>
                <div class="section-content">
                    <div class="feedback-section">
                        <h3 class="feedback-title">
                            <i class="fas fa-chart-bar"></i>
                            How Your Score Was Calculated
                        </h3>
                        <div class="feedback-content" id="score-factors-content">
                            <!-- Score factors explanation will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentAnalysisResult = null;
        let selectedPrompt = null;
        let isMenuOpen = false; // Menu starts closed by default

        // Safe number formatting helper
        function safeToFixed(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) {
                return '0';
            }
            return Number(value).toFixed(decimals);
        }

        // Clear all previous analysis data for fresh start
        function clearPreviousAnalysisData() {
            console.log('🔄 Hard refresh: Clearing all previous analysis data...');
            
            // Reset global analysis result
            currentAnalysisResult = null;
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Clear all analysis grids and content areas
            const elementsToReset = [
                'overview-grid',
                'score-container', 
                'score-explanation',
                'analysis-summary',
                'grammar-details',
                'spelling-details',
                'punctuation-details',
                'style-details',
                'readability-grid',
                'vocabulary-grid',
                'sentence-grid',
                'error-rates-grid',
                'severity-grid',
                'category-grid',
                'suggestions-details',
                'improvement-content',
                'tips-content',
                'score-factors-content'
            ];
            
            elementsToReset.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.tagName === 'DIV' && (id.includes('grid') || id.includes('container'))) {
                        element.innerHTML = ''; // Clear grid/container content
                    } else {
                        element.innerHTML = '<p style="color: #666; font-style: italic;">Analysis results will appear here after clicking "Submit".</p>';
                    }
                }
            });
            
            // Reset menu badges to zero
            const badgeElements = ['grammar-count', 'spelling-count', 'punctuation-count', 'style-count'];
            badgeElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '0';
                    element.className = 'item-badge badge-new';
                }
            });
            
            // Remove any dynamically created error sections from previous analyses
            const dynamicSections = document.querySelectorAll('.content-section[id*="-errors-section"]');
            dynamicSections.forEach(section => {
                if (!['grammar-errors-section', 'spelling-errors-section', 'punctuation-errors-section', 'style-issues-section'].includes(section.id)) {
                    section.remove();
                }
            });
            
            // Close slide-out menu if open
            if (isMenuOpen) {
                toggleMenu();
            }
            
            console.log('✅ Previous analysis data cleared successfully');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            
            // Add test function for debugging (remove in production)
            window.testErrorDetection = function() {
                const testText = "This is a test sentense with erors. I seen this befor, their are alot of mistakes,but the tool should catch them.Your welcome!";
                console.log('🧪 Testing Ga Server API with sample text...');
                console.warn('⚠️ Note: This will make a real API call to api.languagetool.org');
                document.getElementById('writingText').value = testText;
                analyzeWriting();
            };
            
            console.log('🔧 Debug tools available: testErrorDetection() - Tests real Ga Server API');
        });

        function initializePage() {
            updateWordCount();
            updateTimerDisplay();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', toggleMenu);
            
            // ESC key to close menu
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isMenuOpen) {
                    toggleMenu();
                }
            });
        }

        // Menu functionality
        function toggleMenu() {
            const menu = document.getElementById('slideMenu');
            const container = document.getElementById('container');
            const menuToggle = document.getElementById('menuToggle');
            const menuLabel = document.getElementById('menuToggleLabel');

            isMenuOpen = !isMenuOpen;

            if (isMenuOpen) {
                menu.classList.remove('collapsed');
                container.classList.remove('menu-collapsed');
                menuToggle.classList.remove('collapsed');
                menuLabel.classList.remove('collapsed');
                menuToggle.innerHTML = '<i class="fas fa-times"></i>';
                menuLabel.textContent = 'Close';
            } else {
                menu.classList.add('collapsed');
                container.classList.add('menu-collapsed');
                menuToggle.classList.add('collapsed');
                menuLabel.classList.add('collapsed');
                menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
                menuLabel.textContent = 'Analysis';
            }
        }

        // Error Modal Functions
        function showErrorModal(errorMessage) {
            const modal = document.getElementById('errorModal');
            const errorText = document.getElementById('errorMessageText');
            
            errorText.textContent = errorMessage;
            modal.style.display = 'block';
            
            // Close modal when clicking outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeErrorModal();
                }
            };
        }

        function closeErrorModal() {
            const modal = document.getElementById('errorModal');
            modal.style.display = 'none';
        }

        async function copyErrorMessage() {
            const errorText = document.getElementById('errorMessageText').textContent;
            const copyBtn = document.querySelector('.copy-error-btn');
            const originalContent = copyBtn.innerHTML;
            
            try {
                await navigator.clipboard.writeText(errorText);
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalContent;
                    copyBtn.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = errorText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalContent;
                    copyBtn.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
                }, 2000);
            }
        }

        // Navigate to specific analysis section
        function navigateToSection(sectionName) {
            console.log('🧭 Navigating to section:', sectionName);
            
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            console.log('📄 Found sections:', sections.length);
            sections.forEach(section => section.classList.remove('active'));

            // Show the specific section
            const targetSection = document.getElementById(`${sectionName}-section`);
            console.log('🎯 Target section found:', !!targetSection);
            
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log('✅ Section activated:', sectionName);
            } else {
                console.log('❌ Section not found:', `${sectionName}-section`);
                
                // If analysis hasn't been done yet, show a message
                if (!currentAnalysisResult) {
                    alert('Please analyze your writing first by clicking "Submit" button.');
                    return;
                }
            }

            // Update menu badges if analysis is available
            if (currentAnalysisResult) {
                updateMenuBadges();
            }
        }

        // Prompt selection
        function selectPrompt(element, promptIndex) {
            // Remove selected class from all prompts
            document.querySelectorAll('.prompt-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Add selected class to clicked prompt
            element.classList.add('selected');
            selectedPrompt = promptIndex;

            // Auto-fill functionality removed - users should write their own letters
        }

        // Word count functionality
        function updateWordCount() {
            const text = document.getElementById('writingText').value;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const characters = text.length;
            const submitBtn = document.getElementById('analyzeBtn');

            // Update display with IELTS letter writing requirements
            const requirementStatus = words >= 150 ? '✓' : '⚠️';
            document.getElementById('wordCount').textContent = `Words: ${words} | Characters: ${characters} | Required: 150+ ${requirementStatus}`;

                    // Enable/disable button based on word count (minimum 150 words for IELTS)
        if (words >= 150) {
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
        } else {
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
        }

            // Visual feedback for IELTS letter writing requirements
            const wordCountElement = document.getElementById('wordCount');
            if (words >= 150) {
                wordCountElement.style.color = '#28a745';
                wordCountElement.style.fontWeight = '600';
            } else if (words >= 100) {
                wordCountElement.style.color = '#ffc107';
                wordCountElement.style.fontWeight = '500';
            } else {
                wordCountElement.style.color = '#666';
                wordCountElement.style.fontWeight = '500';
            }
        }

        // Timer functionality for IELTS letter writing (20 minutes)
        let timerInterval = null;
        let timeRemaining = 20 * 60; // 20 minutes in seconds
        let timerRunning = false;

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const timeDisplay = display.querySelector('.small-timer-time');
            timeDisplay.textContent = formatTime(timeRemaining);
            
            // Add warning class when under 5 minutes
            if (timeRemaining <= 300) {
                display.classList.add('warning');
            } else {
                display.classList.remove('warning');
            }
        }

        function startTimer() {
            if (!timerRunning) {
                timerRunning = true;
                const startBtn = document.getElementById('startTimerBtn');
                
                // Hide the start button once timer begins
                startBtn.style.display = 'none';
                
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        timeUpAlert();
                        resetTimer();
                    }
                }, 1000);
            }
        }



        function resetTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            timeRemaining = 20 * 60; // Reset to 20 minutes
            
            const startBtn = document.getElementById('startTimerBtn');
            
            // Show the start button again for a new session
            startBtn.style.display = 'flex';
            startBtn.innerHTML = '<i class="fas fa-play"></i> Start';
            
            updateTimerDisplay();
        }

        function timeUpAlert() {
            alert('⏰ Time\'s up! You have completed the 20-minute IELTS General Writing Task 1 time limit.\n\nRecommendation: Submit your letter now to see how you performed within the time constraint.');
            
            // Auto-trigger analysis popup removed - users can submit manually when ready
        }

        // Main analysis function with data refresh
        async function analyzeWriting() {
            // Stop and reset timer when submit is clicked
            if (timerRunning) {
                timerRunning = false;
                clearInterval(timerInterval);
            }
            // Reset timer to initial state
            timeRemaining = 20 * 60; // Reset to 20 minutes
            const startBtn = document.getElementById('startTimerBtn');
            if (startBtn) {
                startBtn.style.display = 'flex';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start';
            }
            updateTimerDisplay();
            
            const text = document.getElementById('writingText').value;
            const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;

            if (text.length === 0) {
                alert('Please write your letter before submitting for analysis.');
                return;
            }

            if (wordCount < 150) {
                alert('Please write at least 150 words to meet IELTS Task 1 letter writing requirements before submitting for analysis.');
                return;
            }

            // Clear all previous analysis data for fresh start
            clearPreviousAnalysisData();

            // Provide visual feedback that data is being refreshed
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<i class="fas fa-sync"></i> Submitting...';
            analyzeBtn.disabled = true;
            
            // Brief delay to show refresh action
            await new Promise(resolve => setTimeout(resolve, 500));

            // Show loading animation
            const loadingElement = document.getElementById('loadingAnimation');
            loadingElement.style.display = 'block';
            
            // Update loading text to show server connection
            const loadingText = loadingElement.querySelector('.loading-text');
            loadingText.textContent = 'Connecting to Ga Server... Please wait...';

            try {
                console.log('🔄 Starting analysis with Open Source LanguageTool API...');
                
                // Perform analysis using Open Source API ONLY
                await performAnalysis(text);
                
                console.log('🎉 Open Source LanguageTool API analysis completed successfully!');
                
                // Open menu automatically after analysis
                if (!isMenuOpen) {
                    toggleMenu();
                }

                // Navigate to overview section
                navigateToSection('overview');

                // Show success message in console
                console.log('📊 You can now explore all analysis sections in the slideout menu!');

            } catch (error) {
                console.error('❌ Analysis failed:', error);
                
                // Show detailed error message with contact information as requested
                let errorMessage = 'Server error, please try after some time. If you still see the error message please copy the message and send to GuruvammalFoundation@outlook.com; our technical team will connect with you shortly\n\n';
                
                // Add error details
                if (error.message.includes('API responded with status')) {
                    const statusMatch = error.message.match(/status (\d+)/);
                    const errorCode = statusMatch ? statusMatch[1] : 'Unknown';
                    errorMessage += `Error Code: ${errorCode}\n`;
                    errorMessage += `Complete Error Message: ${error.message}`;
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage += 'Error Code: Network Error\n';
                    errorMessage += `Complete Error Message: ${error.message}`;
                } else {
                    errorMessage += 'Error Code: General Error\n';
                    errorMessage += `Complete Error Message: ${error.message}`;
                }
                
                showErrorModal(errorMessage);
                
                // Reset loading text for next attempt
                loadingText.textContent = 'Connecting to Ga Server... Please wait...';
                
            } finally {
                // Hide loading animation
                loadingElement.style.display = 'none';
                
                // Restore analyze button
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.innerHTML = 'Submit';
                analyzeBtn.disabled = false;
            }
        }

        // Perform comprehensive analysis (API ONLY)
        async function performAnalysis(text) {
            try {
                console.log('🚀 Starting comprehensive LanguageTool API analysis...');
                const analysisResult = await detectGrammarErrors(text);
                
                if (!analysisResult) {
                    throw new Error('API analysis failed to return results');
                }
                
                // Calculate basic metrics
                const wordCount = text.trim().split(/\s+/).length;
                const sentenceCount = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
                const advancedWords = detectAdvancedWords(text);
                const avgSentenceLength = sentenceCount > 0 ? (wordCount / sentenceCount).toFixed(1) : 0;
                
                // Calculate scores using our custom logic
                const customScores = calculateAPIBasedScores(
                    wordCount, 
                    analysisResult.count, 
                    analysisResult.categoryCount, 
                    0, 
                    (advancedWords.count / wordCount) * 100, 
                    parseFloat(avgSentenceLength), 
                    analysisResult.matches || []
                );

                // Store current analysis result
                currentAnalysisResult = {
                    ...analysisResult,
                    basicMetrics: {
                        wordCount,
                        sentenceCount,
                        advancedWords: advancedWords.words,
                        advancedWordCount: advancedWords.count,
                        avgSentenceLength: parseFloat(avgSentenceLength),
                        characterCount: text.length
                    },
                    scores: {
                        ielts: customScores.ielts,
                        clb: customScores.clb
                    },
                    originalText: text
                };

                console.log('✅ Analysis completed successfully using:', analysisResult.source);
                
                // Update all UI sections
                updateOverviewSection();
                updateScoresSection();
                updateErrorSections();
                updateMenuBadges();
                
            } catch (error) {
                console.error('❌ Analysis failed:', error);
                // Don't update UI on failure, let the error bubble up to analyzeWriting()
                throw error;
            }
        }

        // Update overview section
        function updateOverviewSection() {
            console.log('📊 Updating overview section with result:', currentAnalysisResult);
            
            const result = currentAnalysisResult;
            const metrics = result.basicMetrics;
            
            const overviewGrid = document.getElementById('overview-grid');
            if (!overviewGrid) {
                console.error('❌ Overview grid element not found!');
                return;
            }
            
            console.log('📈 Metrics:', metrics);
            console.log('🔍 Error count:', result.count);
            
            overviewGrid.innerHTML = `
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-file-alt"></i>
                        Word Count
                    </div>
                    <div class="card-value">${metrics.wordCount}</div>
                    <div class="card-description">Total words analyzed</div>
                </div>

                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Total Errors
                    </div>
                    <div class="card-value">${result.count}</div>
                    <div class="card-description">Issues detected by ${result.source || 'analysis engine'}</div>
                </div>

                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-percentage"></i>
                        Error Rate
                    </div>
                    <div class="card-value">${result.detailedAnalysis && result.detailedAnalysis.errorRate ? result.detailedAnalysis.errorRate.toFixed(2) : ((result.count / (metrics.wordCount || 1)) * 100).toFixed(2)}%</div>
                    <div class="card-description">Errors per 100 words</div>
                </div>

                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-brain"></i>
                        Complexity
                    </div>
                    <div class="card-value">${result.detailedAnalysis && result.detailedAnalysis.complexityRatio ? result.detailedAnalysis.complexityRatio.toFixed(1) : (((metrics.advancedWordCount || 0) / (metrics.wordCount || 1)) * 100).toFixed(1)}%</div>
                    <div class="card-description">Advanced vocabulary usage</div>
                </div>

                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Sentence Length
                    </div>
                    <div class="card-value">${metrics.avgSentenceLength}</div>
                    <div class="card-description">Average words per sentence</div>
                </div>

                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-graduation-cap"></i>
                        Reading Level
                    </div>
                    <div class="card-value">${result.detailedAnalysis ? result.detailedAnalysis.readabilityLevel : calculateReadingLevel(metrics.avgSentenceLength, metrics.advancedWordCount, metrics.wordCount)}</div>
                    <div class="card-description">Text complexity assessment</div>
                </div>
            `;

            // Update analysis summary
            const analysisSummary = document.getElementById('analysis-summary');
            analysisSummary.innerHTML = generateAnalysisSummary();
        }

        // Update scores section
        function updateScoresSection() {
            const result = currentAnalysisResult;
            let scores;

            console.log('🖥️ DEBUG - updateScoresSection called');
            console.log('   Using NEW Analysis Summary based scoring');

            // ALWAYS use Analysis Summary values for consistent scoring
            scores = calculateBandsFromAnalysisSummary();
            console.log('✅ Using Analysis Summary based scoring:', scores);

            const scoreContainer = document.getElementById('score-container');
            scoreContainer.innerHTML = `
                <div class="score-card">
                    <div class="score-label">IELTS Writing</div>
                    <div class="score-value">${scores.ielts}</div>
                    <div class="score-range">Band 1-9</div>
                </div>

                <div class="score-card">
                    <div class="score-label">CLB Writing</div>
                    <div class="score-value">${scores.clb}</div>
                    <div class="score-range">Level 1-12</div>
                </div>
            `;

            // Update score explanation
            const scoreExplanation = document.getElementById('score-explanation');
            scoreExplanation.innerHTML = generateScoreExplanation(scores, result);
        }

        // Update error sections
        function updateErrorSections() {
            const result = currentAnalysisResult;
            
            console.log('🔄 Updating error sections...');
            
            console.log('🎨 Updating UI error sections with categorized data...');
            
            // Update grammar errors section
            const grammarErrors = result.errorCategories?.Grammar || [];
            console.log(`📝 Grammar section: ${grammarErrors.length} errors`);
            updateErrorSection('grammar-details', 'Grammar', grammarErrors, result.detailedErrors);
            
            // Update spelling errors section  
            const spellingErrors = result.errorCategories?.Spelling || [];
            console.log(`🔤 Spelling section: ${spellingErrors.length} errors`);
            updateErrorSection('spelling-details', 'Spelling', spellingErrors, result.detailedErrors);

            // Update punctuation errors section
            const punctuationErrors = result.errorCategories?.Punctuation || [];
            console.log(`🎯 Punctuation section: ${punctuationErrors.length} errors`);
            updateErrorSection('punctuation-details', 'Punctuation', punctuationErrors, result.detailedErrors);
            
            // Update style issues section
            const styleErrors = result.errorCategories?.Style || [];
            console.log(`🎨 Style section: ${styleErrors.length} errors`);
            updateErrorSection('style-details', 'Style', styleErrors, result.detailedErrors);

            // Update additional sections
            updateReadabilitySection();
            updateVocabularySection();
            updateSentenceStructureSection();
            updateErrorRatesSection();
            updateSeverityAnalysisSection();
            updateCategoryDistributionSection();
            updateSuggestionsSection();
            updateImprovementAreasSection();
            updateWritingTipsSection();
            updateScoreFactorsSection();

            // Create additional sections dynamically for other error types
            createDynamicErrorSections();
        }

        // Update specific error section
        function updateErrorSection(containerId, categoryName, errors, allErrors) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Ensure errors is an array
            if (!Array.isArray(errors)) {
                console.warn(`Expected array for ${categoryName} errors, got:`, typeof errors, errors);
                errors = [];
            }

            if (errors.length === 0) {
                container.innerHTML = `
                    <div class="error-category">
                        <div class="category-header">
                            <div class="category-name">${categoryName} Analysis</div>
                            <div class="category-count">0</div>
                        </div>
                        <div style="padding: 1rem; text-align: center; color: #28a745; font-weight: 600;">
                            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                            No ${categoryName.toLowerCase()} issues detected! Excellent work!
                        </div>
                    </div>
                `;
                return;
            }

            let errorListHtml = '';
            errors.forEach((error, index) => {
                // Handle both API errors and offline errors
                const message = error.message || error.shortMessage || error;
                const context = error.context?.text || error.context || '';
                const suggestions = error.replacements?.map(r => r.value) || error.suggestions || [];
                const ruleInfo = error.rule?.id ? ` (${error.rule.id})` : '';
                
                console.log(`📋 Rendering error ${index + 1}: "${message}"${ruleInfo}`);
                
                errorListHtml += `
                    <li class="error-item">
                        <strong>${message}${ruleInfo}</strong>
                        ${context ? `<br><small style="color: #666;"><strong>Context:</strong> "${context}"</small>` : ''}
                        ${suggestions.length > 0 ? `<br><small style="color: #007bff;"><strong>Suggestions:</strong> ${suggestions.join(', ')}</small>` : ''}
                        ${error.rule?.category?.id ? `<br><small style="color: #888;"><strong>Type:</strong> ${error.rule.category.id}</small>` : ''}
                    </li>
                `;
            });

            container.innerHTML = `
                <div class="error-category">
                    <div class="category-header">
                        <div class="category-name">${categoryName} Issues</div>
                        <div class="category-count">${errors.length}</div>
                    </div>
                    <ul class="error-list">
                        ${errorListHtml}
                    </ul>
                </div>
            `;
        }

        // Create dynamic error sections for all categories
        function createDynamicErrorSections() {
            const result = currentAnalysisResult;
            if (!result.errorCategories) return;

            const mainContent = document.querySelector('.main-content');
            const categories = ['Punctuation', 'Style', 'Typography', 'Redundancy', 'Colloquialisms', 'Confused Words', 'Casing', 'Whitespace'];

            categories.forEach(category => {
                const sectionId = `${category.toLowerCase().replace(/\s+/g, '-')}-errors-section`;
                let section = document.getElementById(sectionId);

                if (!section) {
                    section = document.createElement('div');
                    section.className = 'content-section';
                    section.id = sectionId;
                    section.innerHTML = `
                        <div class="section-header">
                            <i class="fas fa-${getCategoryIcon(category)} section-icon"></i>
                            <h2 class="section-title-main">${category} Analysis</h2>
                        </div>
                        <div class="section-content">
                            <div class="error-details" id="${category.toLowerCase().replace(/\s+/g, '-')}-details">
                                <!-- Error details will be populated here -->
                            </div>
                        </div>
                    `;
                    mainContent.appendChild(section);
                }

                // Update the section content
                const errors = result.errorCategories[category] || [];
                updateErrorSection(`${category.toLowerCase().replace(/\s+/g, '-')}-details`, category, errors, result.detailedErrors);
            });
        }

        // Get appropriate icon for error category
        function getCategoryIcon(category) {
            const icons = {
                'Punctuation': 'quote-right',
                'Style': 'palette',
                'Typography': 'font',
                'Redundancy': 'compress-alt',
                'Colloquialisms': 'comments',
                'Confused Words': 'question-circle',
                'Casing': 'text-height',
                'Whitespace': 'space-shuttle'
            };
            return icons[category] || 'exclamation-circle';
        }

        // Update menu badges with error counts
        function updateMenuBadges() {
            const result = currentAnalysisResult;
            if (!result) return;

            // Update error count badges
            const badges = {
                'grammar-count': Array.isArray(result.errorCategories?.Grammar) ? result.errorCategories.Grammar.length : 0,
                'spelling-count': Array.isArray(result.errorCategories?.Spelling) ? result.errorCategories.Spelling.length : 0,
                'punctuation-count': Array.isArray(result.errorCategories?.Punctuation) ? result.errorCategories.Punctuation.length : 0,
                'style-count': Array.isArray(result.errorCategories?.Style) ? result.errorCategories.Style.length : 0
            };

            Object.entries(badges).forEach(([id, count]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = count;
                    element.className = count > 0 ? 'item-badge badge-analysis' : 'item-badge badge-new';
                }
            });
        }

        // Generate analysis summary
        function generateAnalysisSummary() {
            const result = currentAnalysisResult;
            const metrics = result.basicMetrics;
            
            let summary = `<div class="feedback-category">`;
            summary += `<h4><i class="fas fa-chart-bar"></i> Analysis Overview</h4>`;
            summary += `<p>Your ${metrics.wordCount}-word text has been analyzed using ${result.source || 'advanced analysis'}. `;
            
            if (result.count === 0) {
                summary += `Excellent work! No significant issues were detected in your writing.</p>`;
            } else {
                summary += `We found ${result.count} areas for improvement across ${Object.keys(result.errorCategories || {}).length} categories.</p>`;
            }
            summary += `</div>`;

            // Add key findings
            if (result.detailedAnalysis) {
                summary += `<div class="feedback-category">`;
                summary += `<h4><i class="fas fa-microscope"></i> Key Findings</h4>`;
                summary += `<ul style="margin-left: 1rem;">`;
                summary += `<li><strong>Error Rate:</strong> ${(result.detailedAnalysis.errorRate || 0).toFixed(2)} errors per 100 words</li>`;
                summary += `<li><strong>Sentence Complexity:</strong> ${(result.detailedAnalysis.avgWordsPerSentence || result.detailedAnalysis.averageWordsPerSentence || 0).toFixed(1)} words per sentence</li>`;
                summary += `<li><strong>Vocabulary Level:</strong> ${(result.detailedAnalysis.complexityRatio || 0).toFixed(1)}% advanced words</li>`;
                summary += `<li><strong>Readability:</strong> ${result.detailedAnalysis.readabilityLevel || 'Unknown'} level</li>`;
                summary += `</ul></div>`;
            }

            return summary;
        }

        // Generate score explanation
        function generateScoreExplanation(scores, result) {
            let explanation = `<div class="feedback-category">`;
            explanation += `<h4><i class="fas fa-medal"></i> Score Breakdown</h4>`;
            explanation += `<p><strong>IELTS ${scores.ielts}/9:</strong> ${getIELTSDescription(scores.ielts)}</p>`;
            explanation += `<p><strong>CLB ${scores.clb}/12:</strong> ${getCLBDescription(scores.clb)}</p>`;
            explanation += `</div>`;

            if (result.scores && result.scores.factors) {
                explanation += `<div class="feedback-category">`;
                explanation += `<h4><i class="fas fa-calculator"></i> Scoring Factors</h4>`;
                explanation += `<ul style="margin-left: 1rem;">`;
                Object.entries(result.scores.factors).forEach(([factor, impact]) => {
                    explanation += `<li><strong>${factor}:</strong> ${impact}</li>`;
                });
                explanation += `</ul></div>`;
            }

            return explanation;
        }

        // IELTS score descriptions
        function getIELTSDescription(score) {
            const descriptions = {
                9: "Expert user - Full operational command",
                8: "Very good user - Fully operational command",
                7: "Good user - Operational command",
                6: "Competent user - Generally effective command",
                5: "Modest user - Partial command",
                4: "Limited user - Basic competence",
                3: "Extremely limited user",
                2: "Intermittent user",
                1: "Non-user"
            };
            return descriptions[score] || "Score assessment";
        }

        // CLB score descriptions
        function getCLBDescription(score) {
            const descriptions = {
                12: "CLB 12 - Advanced proficiency",
                11: "CLB 11 - Advanced proficiency", 
                10: "CLB 10 - Advanced proficiency",
                9: "CLB 9 - High intermediate proficiency",
                8: "CLB 8 - High intermediate proficiency",
                7: "CLB 7 - Intermediate proficiency",
                6: "CLB 6 - Intermediate proficiency",
                5: "CLB 5 - Initial intermediate proficiency",
                4: "CLB 4 - Basic proficiency",
                3: "CLB 3 - Basic proficiency",
                2: "CLB 2 - Basic proficiency",
                1: "CLB 1 - Basic proficiency"
            };
            return descriptions[score] || "Score assessment";
        }

        // All the existing grammar detection and analysis functions...
        // (detectGrammarErrors, checkWithLanguageTool, analyzeLanguageToolResponse, etc.)
        // [Previous functions remain the same as in the current implementation]

        // Ga Server API Only (No Fallback)
        async function detectGrammarErrors(text) {
            console.log('🔍 Starting Ga Server API analysis for text length:', text.length);
            
            // Basic validation
            if (!text || text.trim().length === 0) {
                throw new Error('No text provided for analysis');
            }
            
            console.log('🌐 Connecting to Ga Server (api.languagetool.org)');
            console.log('⚠️ Note: This tool requires the Ga Server. No offline fallback available.');
            
            try {
                // Use ONLY Ga Server API - no fallbacks
                const apiResult = await checkWithLanguageToolAPI(text);
                console.log('✅ Ga Server API analysis completed successfully');
                console.log('📈 Error count:', apiResult.count, 'Categories:', Object.keys(apiResult.errorCategories || {}));
                console.log('🔍 Source:', apiResult.source);
                
                return apiResult;
                
            } catch (apiError) {
                console.error('❌ Ga Server API failed:', apiError.message);
                
                // Throw server error - NO FALLBACKS
                throw new Error(`Server Error: Ga Server is currently unavailable. ${apiError.message}. Please check your internet connection and try again later.`);
            }
        }
        
        // Comprehensive offline text analysis function
        function analyzeTextOffline(text) {
            console.log('🔧 Starting detailed offline text analysis...');
            console.log('📄 Text sample (first 200 chars):', text.substring(0, 200));
            console.log('📊 Text stats:', {
                length: text.length,
                words: text.trim().split(/\s+/).length,
                sentences: text.split(/[.!?]+/).filter(s => s.trim().length > 0).length,
                paragraphs: text.split(/\n\s*\n/).length
            });
            
            const errors = [];
            const errorCategories = {
                'Grammar': [],
                'Spelling': [],
                'Punctuation': [],
                'Style': [],
                'Capitalization': [],
                'Word Choice': [],
                'Sentence Structure': []
            };
            const errorCounts = {
                'Grammar': 0,
                'Spelling': 0,
                'Punctuation': 0,
                'Style': 0,
                'Capitalization': 0,
                'Word Choice': 0,
                'Sentence Structure': 0
            };
            
            // Split text into sentences and words
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const words = text.toLowerCase().match(/\b\w+\b/g) || [];
            const allWords = text.match(/\b\w+\b/g) || [];
            
            // 1. ENHANCED GRAMMAR ERRORS DETECTION
            
            const grammarPatterns = [
                // Common grammar mistakes - expanded patterns
                { pattern: /\bare\s+a\b/gi, replacement: 'is a', category: 'Grammar', message: 'Subject-verb agreement error' },
                { pattern: /\bis\s+a\s+\w+s\b/gi, replacement: 'are', category: 'Grammar', message: 'Subject-verb agreement with plural nouns' },
                { pattern: /\bwould\s+of\b/gi, replacement: 'would have', category: 'Grammar', message: "Use 'would have' instead of 'would of'" },
                { pattern: /\bcould\s+of\b/gi, replacement: 'could have', category: 'Grammar', message: "Use 'could have' instead of 'could of'" },
                { pattern: /\bshould\s+of\b/gi, replacement: 'should have', category: 'Grammar', message: "Use 'should have' instead of 'should of'" },
                { pattern: /\bmight\s+of\b/gi, replacement: 'might have', category: 'Grammar', message: "Use 'might have' instead of 'might of'" },
                { pattern: /\bmust\s+of\b/gi, replacement: 'must have', category: 'Grammar', message: "Use 'must have' instead of 'must of'" },
                { pattern: /\byour\s+welcome\b/gi, replacement: "you're welcome", category: 'Grammar', message: "Use 'you're welcome' (you are welcome)" },
                { pattern: /\bits\s+a\s+\w+\s+who\b/gi, replacement: 'that', category: 'Grammar', message: "Use 'that' for objects, 'who' for people" },
                { pattern: /\bmuch\s+\w+s\b/gi, replacement: 'many', category: 'Grammar', message: "Use 'many' with countable nouns" },
                { pattern: /\bless\s+\w+s\b/gi, replacement: 'fewer', category: 'Grammar', message: "Use 'fewer' with countable nouns" },
                { pattern: /\bbetween\s+\w+\s+and\s+I\b/gi, replacement: 'me', category: 'Grammar', message: "Use 'me' in prepositional phrases" },
                // Additional common errors
                { pattern: /\bthere\s+is\s+\w+s\b/gi, replacement: 'there are', category: 'Grammar', message: "Use 'there are' with plural nouns" },
                { pattern: /\bi\s+seen\b/gi, replacement: 'I saw', category: 'Grammar', message: "Use 'I saw' instead of 'I seen'" },
                { pattern: /\bi\s+done\b/gi, replacement: 'I did', category: 'Grammar', message: "Use 'I did' instead of 'I done'" },
                { pattern: /\bain't\b/gi, replacement: "isn't", category: 'Grammar', message: "Use 'isn't' instead of 'ain't'" },
                { pattern: /\bdouble\s+negative/gi, replacement: '', category: 'Grammar', message: 'Avoid double negatives' },
                { pattern: /\bdon't\s+have\s+no\b/gi, replacement: "don't have any", category: 'Grammar', message: 'Avoid double negative' },
                { pattern: /\bcan't\s+get\s+no\b/gi, replacement: "can't get any", category: 'Grammar', message: 'Avoid double negative' }
            ];
            
            grammarPatterns.forEach(pattern => {
                let match;
                const regex = new RegExp(pattern.pattern.source, pattern.pattern.flags);
                while ((match = regex.exec(text)) !== null) {
                    const errorObj = {
                        message: pattern.message,
                        category: pattern.category,
                        offset: match.index,
                        length: match[0].length,
                        context: text.substring(Math.max(0, match.index - 20), match.index + match[0].length + 20),
                        suggestions: [pattern.replacement],
                        severity: 'high'
                    };
                    errors.push(errorObj);
                    errorCategories[pattern.category].push(errorObj);
                    errorCounts[pattern.category]++;
                }
            });
            
            // 2. SPELLING ERRORS
            
            const commonMisspellings = {
                // Common misspellings - significantly expanded
                'recieve': 'receive', 'seperate': 'separate', 'definately': 'definitely',
                'occured': 'occurred', 'begining': 'beginning', 'befor': 'before',
                'untill': 'until', 'wich': 'which', 'whith': 'with',
                'sentense': 'sentence', 'erors': 'errors', 'wierd': 'weird',
                'freind': 'friend', 'buisness': 'business', 'realy': 'really',
                'alot': 'a lot', 'loose': 'lose', 'chose': 'choose',
                'accomodate': 'accommodate', 'acheive': 'achieve', 'adress': 'address',
                'apparant': 'apparent', 'arguement': 'argument', 'beleive': 'believe',
                'calender': 'calendar', 'cemetary': 'cemetery', 'changeable': 'changeable',
                'collegue': 'colleague', 'commited': 'committed', 'competative': 'competitive',
                'concious': 'conscious', 'definite': 'definite', 'desparate': 'desperate',
                'embarass': 'embarrass', 'enviroment': 'environment', 'existance': 'existence',
                'foriegn': 'foreign', 'goverment': 'government', 'grammer': 'grammar',
                'independant': 'independent', 'intelligible': 'intelligible', 'intresting': 'interesting',
                'liason': 'liaison', 'maintainance': 'maintenance', 'managerial': 'managerial',
                'neccessary': 'necessary', 'occassion': 'occasion', 'outragous': 'outrageous',
                'paralell': 'parallel', 'perseverence': 'perseverance', 'posession': 'possession',
                'priviledge': 'privilege', 'publically': 'publicly', 'reccommend': 'recommend',
                'seperate': 'separate', 'succesful': 'successful', 'tommorow': 'tomorrow',
                'unfortunatly': 'unfortunately', 'usualy': 'usually', 'vaccum': 'vacuum',
                'wether': 'whether', 'yeilds': 'yields',
                // Homophones and commonly confused words
                'there': ['their', 'they\'re'], 'your': ['you\'re'], 'its': ['it\'s'],
                'to': ['too', 'two'], 'then': ['than'], 'affect': ['effect'],
                'accept': ['except'], 'advice': ['advise'], 'breathe': ['breath'],
                'complement': ['compliment'], 'desert': ['dessert'], 'loose': ['lose'],
                'principle': ['principal'], 'stationary': ['stationery'], 'weather': ['whether']
            };
            
            words.forEach((word, index) => {
                if (commonMisspellings[word]) {
                    const suggestions = Array.isArray(commonMisspellings[word]) ? 
                        commonMisspellings[word] : [commonMisspellings[word]];
                    
                    // Find position in original text
                    const wordStart = text.toLowerCase().indexOf(word, index > 0 ? text.toLowerCase().indexOf(words[index-1]) + words[index-1].length : 0);
                    
                    const errorObj = {
                        message: `Possible spelling error: "${word}"`,
                        category: 'Spelling',
                        offset: wordStart,
                        length: word.length,
                        context: text.substring(Math.max(0, wordStart - 15), wordStart + word.length + 15),
                        suggestions: suggestions,
                        severity: 'medium'
                    };
                    errors.push(errorObj);
                    errorCategories['Spelling'].push(errorObj);
                    errorCounts['Spelling']++;
                }
            });
            
            // 3. PUNCTUATION ERRORS
            
            const punctuationPatterns = [
                // Enhanced punctuation patterns
                { pattern: /\w,\w/g, category: 'Punctuation', message: 'Missing space after comma' },
                { pattern: /\w\.\w/g, category: 'Punctuation', message: 'Missing space after period' },
                { pattern: /\w\?\w/g, category: 'Punctuation', message: 'Missing space after question mark' },
                { pattern: /\w!\w/g, category: 'Punctuation', message: 'Missing space after exclamation mark' },
                { pattern: /\w;\w/g, category: 'Punctuation', message: 'Missing space after semicolon' },
                { pattern: /\w:\w/g, category: 'Punctuation', message: 'Missing space after colon' },
                { pattern: /\s{2,}/g, category: 'Punctuation', message: 'Multiple spaces should be single space' },
                { pattern: /\s+[,.!?;:]/g, category: 'Punctuation', message: 'Remove space before punctuation' },
                { pattern: /[,.!?]{2,}/g, category: 'Punctuation', message: 'Multiple punctuation marks' },
                { pattern: /\w'\w/g, category: 'Punctuation', message: 'Check apostrophe usage' },
                { pattern: /"[^"]*$/g, category: 'Punctuation', message: 'Missing closing quotation mark' },
                { pattern: /^[^"]*"/g, category: 'Punctuation', message: 'Missing opening quotation mark' },
                { pattern: /\([^)]*$/g, category: 'Punctuation', message: 'Missing closing parenthesis' },
                { pattern: /^[^(]*\)/g, category: 'Punctuation', message: 'Missing opening parenthesis' },
                { pattern: /\s+\./g, category: 'Punctuation', message: 'Remove space before period' },
                { pattern: /,,+/g, category: 'Punctuation', message: 'Multiple commas' },
                { pattern: /\.{4,}/g, category: 'Punctuation', message: 'Too many periods (use ellipsis: ...)' },
                { pattern: /\?{2,}/g, category: 'Punctuation', message: 'Multiple question marks' },
                { pattern: /!{2,}/g, category: 'Punctuation', message: 'Multiple exclamation marks' }
            ];
            
            punctuationPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.pattern.exec(text)) !== null) {
                    const errorObj = {
                        message: pattern.message,
                        category: pattern.category,
                        offset: match.index,
                        length: match[0].length,
                        context: text.substring(Math.max(0, match.index - 10), match.index + match[0].length + 10),
                        suggestions: [],
                        severity: 'low'
                    };
                    errors.push(errorObj);
                    errorCategories[pattern.category].push(errorObj);
                    errorCounts[pattern.category]++;
                }
            });
            
            // 4. CAPITALIZATION ERRORS
            
            // Check sentence beginnings
            const sentenceStarts = text.match(/[.!?]\s+[a-z]/g);
            if (sentenceStarts) {
                sentenceStarts.forEach((match, index) => {
                    const errorObj = {
                        message: 'Sentence should start with capital letter',
                        category: 'Capitalization',
                        offset: text.indexOf(match) + match.length - 1,
                        length: 1,
                        context: match,
                        suggestions: [],
                        severity: 'medium'
                    };
                    errors.push(errorObj);
                    errorCategories['Capitalization'].push(errorObj);
                    errorCounts['Capitalization']++;
                });
            }
            
            // Check first word of text
            if (text.length > 0 && text[0] !== text[0].toUpperCase()) {
                const errorObj = {
                    message: 'Text should start with capital letter',
                    category: 'Capitalization',
                    offset: 0,
                    length: 1,
                    context: text.substring(0, 10),
                    suggestions: [],
                    severity: 'medium'
                };
                errors.push(errorObj);
                errorCategories['Capitalization'].push(errorObj);
                errorCounts['Capitalization']++;
            }
            
            // 5. STYLE AND WORD CHOICE
            
            const stylePatterns = [
                { pattern: /\bvery\s+\w+/gi, category: 'Style', message: 'Consider using a stronger adjective instead of "very"' },
                { pattern: /\bthat\s+that\b/gi, category: 'Style', message: 'Redundant use of "that"' },
                { pattern: /\bin\s+order\s+to\b/gi, category: 'Style', message: 'Consider using "to" instead of "in order to"' },
                { pattern: /\bdue\s+to\s+the\s+fact\s+that\b/gi, category: 'Style', message: 'Consider using "because" instead' }
            ];
            
            stylePatterns.forEach(pattern => {
                let match;
                const regex = new RegExp(pattern.pattern.source, pattern.pattern.flags);
                while ((match = regex.exec(text)) !== null) {
                    const errorObj = {
                        message: pattern.message,
                        category: pattern.category,
                        offset: match.index,
                        length: match[0].length,
                        context: text.substring(Math.max(0, match.index - 15), match.index + match[0].length + 15),
                        suggestions: [],
                        severity: 'low'
                    };
                    errors.push(errorObj);
                    errorCategories[pattern.category].push(errorObj);
                    errorCounts[pattern.category]++;
                }
            });
            
            // 6. CALCULATE METRICS
            
            const wordCount = allWords.length;
            const sentenceCount = sentences.length;
            const averageWordsPerSentence = sentenceCount > 0 ? wordCount / sentenceCount : 0;
            const averageSyllablesPerWord = calculateAverageSyllables(allWords) || 0;
            
            // Readability (Flesch Reading Ease approximation)
            const readabilityScore = 206.835 - (1.015 * averageWordsPerSentence) - (84.6 * averageSyllablesPerWord);
            
            // Advanced vocabulary detection
            const advancedWords = detectAdvancedVocabulary(allWords) || [];
            const advancedWordPercentage = wordCount > 0 ? (advancedWords.length / wordCount) * 100 : 0;
            
            // Error rates (using safe calculations)
            const errorRate = wordCount > 0 ? (errors.length / wordCount) * 100 : 0;
            const grammarErrorRate = wordCount > 0 ? ((errorCounts['Grammar'] || 0) / wordCount) * 100 : 0;
            const spellingErrorRate = wordCount > 0 ? ((errorCounts['Spelling'] || 0) / wordCount) * 100 : 0;
            
            // Calculate IELTS and CELPIP scores based on error type analysis
            const scores = calculateErrorBasedScores(errorCategories);
            
            // Comprehensive analysis result
            const analysisResult = {
                count: errors.length,
                errors: errors,
                errorCategories: errorCategories,
                source: 'Offline Analysis (Network Independent)',
                
                // Detailed metrics
                detailedAnalysis: {
                    wordCount: wordCount,
                    sentenceCount: sentenceCount,
                    averageWordsPerSentence: parseFloat(safeToFixed(averageWordsPerSentence, 1)),
                    avgWordsPerSentence: parseFloat(safeToFixed(averageWordsPerSentence, 1)), // Alternative property name
                    averageSyllablesPerWord: parseFloat(safeToFixed(averageSyllablesPerWord, 1)),
                    readabilityScore: parseFloat(safeToFixed(readabilityScore, 1)),
                    readabilityLevel: getReadabilityLevel(readabilityScore) || 'Unknown',
                    advancedWords: advancedWords,
                    advancedWordCount: advancedWords.length || 0,
                    advancedWordPercentage: parseFloat(safeToFixed(advancedWordPercentage, 1)),
                    errorRate: parseFloat(safeToFixed(errorRate, 2)),
                    grammarErrorRate: parseFloat(safeToFixed(grammarErrorRate, 2)),
                    spellingErrorRate: parseFloat(safeToFixed(spellingErrorRate, 2)),
                    complexityRatio: calculateComplexityRatio(allWords) || 0,
                    repetitionScore: calculateRepetitionScore(allWords) || 0,
                    cohesionScore: calculateCohesionScore(sentences) || 0
                },
                
                scores: scores,
                
                // API format compatibility
                apiData: {
                    language: { name: 'English (US)', code: 'en-US' },
                    software: { name: 'Offline Grammar Analyzer', version: '1.0' },
                    warnings: {
                        incompleteResults: false
                    }
                }
            };
            
            // Log comprehensive analysis summary
            console.log('📊 Offline Analysis Complete Summary:');
            console.log('  📝 Text length:', wordCount, 'words,', text.length, 'characters');
            console.log('  🔍 Total errors detected:', errors.length);
            console.log('  📂 Error breakdown:');
            Object.entries(errorCounts).forEach(([category, count]) => {
                if (count > 0) {
                    console.log(`    ${category}: ${count} errors`);
                }
            });
            console.log('  🎯 First 5 errors:', errors.slice(0, 5).map(e => e.message));
            console.log('📊 Complete offline analysis:', analysisResult);
            return analysisResult;
        }

        // Open Source LanguageTool API integration (PRIMARY METHOD)
        async function checkWithLanguageToolAPI(text) {
            const API_URL = 'https://api.languagetool.org/v2/check';
            
            console.log('🌐 Open Source LanguageTool API URL:', API_URL);
            console.log('📝 Text length:', text.length, 'characters');
            
            // Check text length limit (LanguageTool free API limit is 20KB)
            if (text.length > 20000) {
                console.warn('⚠️ Text exceeds 20KB limit, truncating...');
                text = text.substring(0, 20000);
            }
            
            // Use URL-encoded form data with enhanced parameters for comprehensive checking
            const params = new URLSearchParams();
            params.append('text', text);
            params.append('language', 'en-US');
            params.append('enabledOnly', 'false'); // Enable all rules
            params.append('level', 'picky'); // Use picky level for maximum error detection
            params.append('enabledCategories', 'GRAMMAR,PUNCTUATION,SPELLING,STYLE,MISC,TYPOS,COLLOQUIALISMS');
            params.append('disabledRules', ''); // Don't disable any rules
            params.append('enabledRules', ''); // Let all rules run
            
            console.log('📤 Sending request to Ga Server...');
            console.log('📋 Enhanced API Parameters:', {
                text: text.substring(0, 100) + '...',
                language: 'en-US',
                enabledOnly: 'false',
                level: 'picky',
                enabledCategories: 'GRAMMAR,PUNCTUATION,SPELLING,STYLE,MISC,TYPOS,COLLOQUIALISMS',
                textLength: text.length
            });

            const response = await fetch(API_URL, {
                method: 'POST',
                body: params,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                    'Accept': 'application/json'
                }
            });

            console.log('📡 Response status:', response.status);
            console.log('📡 Response headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ Open Source API Error Response:', errorText);
                
                // Provide detailed error information
                if (response.status === 400) {
                    throw new Error(`LanguageTool API error 400 (Bad Request): ${errorText}. This usually means invalid parameters or missing text data.`);
                } else if (response.status === 403) {
                    throw new Error(`LanguageTool API error 403 (Forbidden): ${errorText}. Access denied - possibly due to rate limiting.`);
                } else if (response.status === 429) {
                    throw new Error(`LanguageTool API error 429 (Too Many Requests): ${errorText}. Rate limit exceeded.`);
                } else {
                    throw new Error(`LanguageTool API error ${response.status}: ${errorText}`);
                }
            }

            const data = await response.json();
            console.log('✅ Ga Server Response received');
            console.log('📊 Response summary:', {
                totalMatches: data.matches?.length || 0,
                language: data.language?.name || 'Unknown',
                software: data.software?.name || 'Unknown'
            });
            
            // Log sample errors if any
            if (data.matches && data.matches.length > 0) {
                console.log('🔍 Sample Ga Server errors (first 3):');
                data.matches.slice(0, 3).forEach((match, i) => {
                    console.log(`  ${i + 1}. ${match.message} [${match.rule?.category?.id || 'Unknown'}]`);
                });
            }
            
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid API response format from LanguageTool server');
            }
            
            return analyzeLanguageToolResponse(data, text);
        }
        
        // Analysis result processor for LanguageTool API response
        function analyzeLanguageToolResponse(data, originalText) {
            console.log('🔧 Processing LanguageTool API response...');
            
            const errors = data.matches || [];
            const errorCategories = {
                'Grammar': [],
                'Spelling': [],
                'Punctuation': [],
                'Style': [],
                'Capitalization': [],
                'Word Choice': [],
                'Sentence Structure': [],
                'Typography': [],
                'Redundancy': [],
                'Consistency': []
            };
            const errorCounts = {
                'Grammar': 0,
                'Spelling': 0,
                'Punctuation': 0,
                'Style': 0,
                'Capitalization': 0,
                'Word Choice': 0,
                'Sentence Structure': 0,
                'Typography': 0,
                'Redundancy': 0,
                'Consistency': 0
            };
            
            // Process each error from LanguageTool
            console.log('📋 Processing', errors.length, 'errors from LanguageTool API');
            errors.forEach((error, index) => {
                // Log first few errors to understand API structure
                if (index < 3) {
                    console.log(`🔍 Error ${index + 1}:`, {
                        message: error.message,
                        ruleId: error.rule?.id,
                        category: error.rule?.category?.id,
                        issueType: error.rule?.issueType,
                        context: error.context?.text
                    });
                }
                
                const category = categorizeLanguageToolError(error);
                console.log(`📂 Categorized error "${error.message?.substring(0, 50)}..." as: ${category}`);
                
                if (errorCategories.hasOwnProperty(category)) {
                    errorCategories[category].push(error);
                    errorCounts[category]++;
                } else {
                    console.warn(`⚠️ Unknown category "${category}", defaulting to Grammar`);
                    errorCategories['Grammar'].push(error);
                    errorCounts['Grammar']++; // Default fallback
                }
            });
            
            // Log categorization summary
            console.log('📊 Final categorization summary:');
            Object.entries(errorCounts).forEach(([category, count]) => {
                if (count > 0) {
                    console.log(`  ${category}: ${count} errors`);
                }
            });
            
            // Calculate comprehensive metrics
            const words = originalText.match(/\b\w+\b/g) || [];
            const sentences = originalText.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const wordCount = words.length;
            const sentenceCount = sentences.length;
            const averageWordsPerSentence = sentenceCount > 0 ? wordCount / sentenceCount : 0;
            const averageSyllablesPerWord = calculateAverageSyllables(words);
            
            // Readability (Flesch Reading Ease)
            const readabilityScore = 206.835 - (1.015 * averageWordsPerSentence) - (84.6 * averageSyllablesPerWord);
            
            // Advanced vocabulary detection
            const advancedWords = detectAdvancedVocabulary(words);
            const advancedWordPercentage = wordCount > 0 ? (advancedWords.length / wordCount) * 100 : 0;
            
            // Error rates
            const errorRate = wordCount > 0 ? (errors.length / wordCount) * 100 : 0;
            const grammarErrorRate = wordCount > 0 ? (errorCounts['Grammar'] / wordCount) * 100 : 0;
            const spellingErrorRate = wordCount > 0 ? (errorCounts['Spelling'] / wordCount) * 100 : 0;
            
            // Calculate IELTS and CELPIP scores based on error type analysis
            const scores = calculateErrorBasedScores(errorCategories);
            
            // Return comprehensive analysis result
            return {
                count: errors.length,
                errors: errors,
                errorCategories: errorCategories,
                source: 'Open Source LanguageTool API',
                
                // Detailed metrics
                detailedAnalysis: {
                    wordCount: wordCount,
                    sentenceCount: sentenceCount,
                    averageWordsPerSentence: parseFloat(safeToFixed(averageWordsPerSentence, 1)),
                    avgWordsPerSentence: parseFloat(safeToFixed(averageWordsPerSentence, 1)), // Alternative property name
                    averageSyllablesPerWord: parseFloat(safeToFixed(averageSyllablesPerWord, 1)),
                    readabilityScore: parseFloat(safeToFixed(readabilityScore, 1)),
                    readabilityLevel: getReadabilityLevel(readabilityScore) || 'Unknown',
                    advancedWords: advancedWords,
                    advancedWordCount: advancedWords.length || 0,
                    advancedWordPercentage: parseFloat(safeToFixed(advancedWordPercentage, 1)),
                    errorRate: parseFloat(safeToFixed(errorRate, 2)),
                    grammarErrorRate: parseFloat(safeToFixed(grammarErrorRate, 2)),
                    spellingErrorRate: parseFloat(safeToFixed(spellingErrorRate, 2)),
                    complexityRatio: calculateComplexityRatio(words) || 0,
                    repetitionScore: calculateRepetitionScore(words) || 0,
                    cohesionScore: calculateCohesionScore(sentences) || 0
                },
                
                scores: scores,
                
                // API format compatibility
                apiData: {
                    language: data.language || { name: 'English (US)', code: 'en-US' },
                    software: data.software || { name: 'Open Source LanguageTool', version: 'Latest' },
                    warnings: data.warnings || { incompleteResults: false }
                }
            };
        }
        
        // Enhanced categorization for LanguageTool errors
        function categorizeLanguageToolError(error) {
            const ruleId = (error.rule?.id || '').toLowerCase();
            const category = (error.rule?.category?.id || '').toLowerCase();
            const issueType = (error.rule?.issueType || '').toLowerCase();
            const message = (error.message || '').toLowerCase();
            
            console.log(`🔍 Categorizing: ruleId="${ruleId}", category="${category}", issueType="${issueType}"`);
            
            // Spelling errors - comprehensive patterns
            if (ruleId.includes('spell') || ruleId.includes('morfologik') || 
                category.includes('spell') || category === 'typos' ||
                issueType.includes('misspelling') || issueType.includes('spelling') ||
                message.includes('misspell') || message.includes('spelling') || 
                message.includes('not found in dictionary')) {
                return 'Spelling';
            }
            
            // Punctuation errors - comprehensive patterns  
            if (ruleId.includes('punct') || ruleId.includes('comma') || ruleId.includes('period') ||
                ruleId.includes('apostrophe') || ruleId.includes('quotation') || ruleId.includes('hyphen') ||
                category.includes('punct') || category === 'punctuation' ||
                issueType.includes('punctuation') || 
                message.includes('comma') || message.includes('period') || message.includes('apostrophe') ||
                message.includes('quotation') || message.includes('colon') || message.includes('semicolon')) {
                return 'Punctuation';
            }
            
            // Capitalization errors
            if (ruleId.includes('cap') || ruleId.includes('uppercase') || ruleId.includes('lowercase') ||
                category.includes('cap') || category.includes('case') ||
                issueType.includes('capitalization') || issueType.includes('case') ||
                message.includes('capital') || message.includes('uppercase') || message.includes('lowercase')) {
                return 'Capitalization';
            }
            
            // Style errors
            if (ruleId.includes('style') || ruleId.includes('conciseness') || ruleId.includes('wordiness') ||
                category.includes('style') || category === 'misc' ||
                issueType.includes('style') || issueType.includes('non-conformance') ||
                message.includes('wordy') || message.includes('concise') || message.includes('style')) {
                return 'Style';
            }
            
            // Typography errors
            if (ruleId.includes('typo') || ruleId.includes('typography') || ruleId.includes('whitespace') ||
                category.includes('typo') || category.includes('typography') ||
                issueType.includes('typography') || issueType.includes('formatting') ||
                message.includes('space') || message.includes('formatting')) {
                return 'Typography';
            }
            
            // Redundancy errors
            if (ruleId.includes('redundan') || ruleId.includes('repetition') || ruleId.includes('duplicate') ||
                category.includes('redundan') || category.includes('repetition') ||
                issueType.includes('redundancy') ||
                message.includes('redundant') || message.includes('repetitive') || message.includes('duplicate')) {
                return 'Redundancy';
            }
            
            // Grammar errors - comprehensive patterns
            if (ruleId.includes('grammar') || ruleId.includes('agreement') || ruleId.includes('verb') ||
                ruleId.includes('tense') || ruleId.includes('subject') || ruleId.includes('plural') ||
                category.includes('grammar') || category === 'grammar' ||
                issueType.includes('grammar') || issueType.includes('agreement') ||
                message.includes('grammar') || message.includes('agreement') || message.includes('verb') ||
                message.includes('subject') || message.includes('tense')) {
                return 'Grammar';
            }
            
            // Consistency errors
            if (ruleId.includes('consisten') || category.includes('consisten') ||
                issueType.includes('consistency') || message.includes('consistent')) {
                return 'Consistency';
            }
            
            // Word choice errors
            if (ruleId.includes('confused') || ruleId.includes('wrong_word') || 
                category.includes('confused') || issueType.includes('confused') ||
                message.includes('confused') || message.includes('wrong word')) {
                return 'Word Choice';
            }
            
            // Default to Grammar for unmatched errors
            console.log(`⚠️ Unmatched error pattern, defaulting to Grammar`);
            return 'Grammar';
        }
        
        // Custom band scoring based on specific criteria
        function calculateAPIBasedScores(wordCount, errorCount, errorCategories, readabilityScore, advancedWordPercentage, averageWordsPerSentence, languageToolErrors) {
            const totalErrors = errorCount;
            const complexityRatio = advancedWordPercentage;
            
            let ielts = 5, celpip = 6; // Default values
            
            // Custom band scoring logic
            if (totalErrors < 2 && wordCount > 150 && complexityRatio > 30) {
                // Band 8 (CELPIP 10): Total Error < 2 AND Word count > 150 AND Complexity > 30%
                ielts = 8;
                celpip = 10;
            }
            if (totalErrors === 2 && wordCount > 150 && complexityRatio < 25) {
                // Band 7 (CELPIP 9): Total Error = 2 AND Word count > 150 AND Complexity < 25%
                ielts = 7;
                celpip = 9;
            }
            if (totalErrors === 3 && wordCount > 150 && complexityRatio < 15) {
                // Band 6 (CELPIP 8): Total Error = 3 AND Word count > 150 AND Complexity < 15%
                ielts = 6;
                celpip = 8;
            }
            if (totalErrors > 3 || wordCount < 150 || complexityRatio < 5) {
                // Band 5 (CELPIP 6): Total Error > 3 OR Word count < 150 OR Complexity < 5%
                ielts = 5;
                celpip = 6;
            } else {
                // Default fallback for edge cases
                ielts = 6;
                celpip = 8;
            }
            
            return {
                ielts: ielts,
                celpip: celpip,
                baseScore: parseFloat(((ielts / 9) * 100).toFixed(1)),
                factors: {
                    errorRate: parseFloat((errorCount / wordCount * 100).toFixed(2)),
                    severityAdjustedErrorRate: parseFloat((errorCount / wordCount * 100).toFixed(2)),
                    vocabularyScore: parseFloat((advancedWordPercentage || 20).toFixed(1)),
                    sentenceComplexityScore: parseFloat((averageWordsPerSentence || 15).toFixed(1)),
                    readabilityScore: parseFloat((readabilityScore || 50).toFixed(1)),
                    lengthScore: parseFloat((wordCount > 150 ? 100 : (wordCount / 150) * 100).toFixed(1))
                }
            };
        }

        // Analyze LanguageTool API response
        function analyzeLanguageToolResponse(data, originalText) {
            const matches = data.matches || [];
            const totalWords = originalText.trim().split(/\s+/).length;
            const sentences = originalText.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const avgWordsPerSentence = sentences.length > 0 ? totalWords / sentences.length : 0;

            // Categorize errors
            const errorCategories = {
                'Grammar': [],
                'Spelling': [],
                'Punctuation': [],
                'Style': [],
                'Typography': [],
                'Redundancy': [],
                'Colloquialisms': [],
                'Confused Words': [],
                'Casing': [],
                'Whitespace': [],
                'Others': []
            };

            // Severity levels
            const severityLevels = { high: 0, medium: 0, low: 0 };
            let totalErrors = 0;

            matches.forEach(match => {
                totalErrors++;
                const category = categorizeError(match);
                const severity = determineSeverity(match);
                
                errorCategories[category].push({
                    message: match.message,
                    context: match.context.text.substring(match.context.offset, match.context.offset + match.context.length),
                    suggestions: match.replacements ? match.replacements.slice(0, 3).map(r => r.value) : [],
                    ruleId: match.rule.id,
                    issueType: match.rule.issueType
                });

                severityLevels[severity]++;
            });

            // Calculate metrics
            const errorRate = totalWords > 0 ? (totalErrors / totalWords) * 100 : 0;
            const grammarErrorRate = totalWords > 0 ? (errorCategories.Grammar.length / totalWords) * 100 : 0;
            const spellingErrorRate = totalWords > 0 ? (errorCategories.Spelling.length / totalWords) * 100 : 0;
            const punctuationErrorRate = totalWords > 0 ? (errorCategories.Punctuation.length / totalWords) * 100 : 0;

            // Calculate complexity
            const complexWords = originalText.split(/\s+/).filter(word => word.length >= 6).length;
            const complexityRatio = totalWords > 0 ? (complexWords / totalWords) * 100 : 0;

            // Determine readability level
            let readabilityLevel = 'Beginner';
            if (avgWordsPerSentence > 20 && complexityRatio > 30) readabilityLevel = 'Advanced';
            else if (avgWordsPerSentence > 15 || complexityRatio > 20) readabilityLevel = 'Intermediate';

            const detailedAnalysis = {
                totalWords,
                totalErrors,
                errorRate,
                grammarErrorRate,
                spellingErrorRate,  
                punctuationErrorRate,
                avgWordsPerSentence,
                complexityRatio,
                readabilityLevel,
                severityDistribution: severityLevels
            };

            // Calculate IELTS and CELPIP scores based on error type analysis
            const scores = calculateErrorBasedScores(errorCategories);

            return {
                count: totalErrors,
                errorCategories: errorCategories,
                severityLevels: severityLevels,
                detailedAnalysis: detailedAnalysis,
                errors: matches.map(m => m.message),
                detailedErrors: matches,
                scores: scores,
                source: 'LanguageTool API (Comprehensive)',
                apiData: data
            };
        }

        // Categorize error based on LanguageTool response
        function categorizeError(match) {
            const categoryId = match.rule.category.id;
            const issueType = match.rule.issueType;
            const ruleId = match.rule.id;

            // Map LanguageTool categories to our categories
            if (categoryId === 'GRAMMAR' || issueType === 'grammar') return 'Grammar';
            if (categoryId === 'TYPOS' || issueType === 'misspelling') return 'Spelling';
            if (categoryId === 'PUNCTUATION' || issueType === 'punctuation') return 'Punctuation';
            if (categoryId === 'STYLE' || issueType === 'style') return 'Style';
            if (categoryId === 'TYPOGRAPHY' || issueType === 'typographical') return 'Typography';
            if (categoryId === 'REDUNDANCY') return 'Redundancy';
            if (categoryId === 'COLLOQUIALISMS') return 'Colloquialisms';
            if (categoryId === 'CONFUSED_WORDS') return 'Confused Words';
            if (categoryId === 'CASING' || issueType === 'locale-violation') return 'Casing';
            if (categoryId === 'WHITESPACE' || issueType === 'whitespace') return 'Whitespace';
            
            return 'Others';
        }

        // Determine error severity
        function determineSeverity(match) {
            const issueType = match.rule.issueType;
            
            if (issueType === 'grammar' || issueType === 'misspelling') return 'high';
            if (issueType === 'punctuation' || issueType === 'style') return 'medium';
            return 'low';
        }



        // Calculate IELTS and CELPIP scores using custom criteria
        function calculateErrorBasedScores(errorCategories) {
            console.log('📊 Calculating scores based on error type analysis...');
            
            // Extract counts for the specific error types
            const grammarCount = (errorCategories.Grammar && Array.isArray(errorCategories.Grammar)) ? errorCategories.Grammar.length : 0;
            const spellingCount = (errorCategories.Spelling && Array.isArray(errorCategories.Spelling)) ? errorCategories.Spelling.length : 0;
            const punctuationCount = (errorCategories.Punctuation && Array.isArray(errorCategories.Punctuation)) ? errorCategories.Punctuation.length : 0;
            const styleCount = (errorCategories.Style && Array.isArray(errorCategories.Style)) ? errorCategories.Style.length : 0;
            
            console.log(`📈 Error counts - Grammar: ${grammarCount}, Spelling: ${spellingCount}, Punctuation: ${punctuationCount}, Style: ${styleCount}`);
            
            // Calculate total errors across all types
            const totalErrors = grammarCount + spellingCount + punctuationCount + styleCount;
            
            let ieltsScore = 5, celpipScore = 6; // Default values
            
            // We need word count and complexity for custom logic - use global variables if available
            const wordCount = currentAnalysisResult?.basicMetrics?.wordCount || 150;
                        const complexityRatio = currentAnalysisResult?.basicMetrics ? 
                (currentAnalysisResult.basicMetrics.advancedWordCount / currentAnalysisResult.basicMetrics.wordCount) * 100 : 20;
            
            // Custom band scoring logic with separate if statements
             if (totalErrors < 2 && wordCount > 150 && complexityRatio > 25) {
                 // IELTS Band = 8, CELPIP = 10
                 ieltsScore = 8;
                 celpipScore = 10;
                 console.log('🎉 Band 8: Low errors, good length, high complexity');
             }
             if (totalErrors === 2 && wordCount > 150 && complexityRatio < 20) {
                 // IELTS Band = 7, CELPIP = 9
                 ieltsScore = 7;
                 celpipScore = 9;
                 console.log('✅ Band 7: 2 errors, good length, moderate complexity');
             }
             if (totalErrors === 3 && wordCount > 150 && complexityRatio < 15) {
                 // IELTS Band = 6, CELPIP = 8
                 ieltsScore = 6;
                 celpipScore = 8;
                 console.log('📝 Band 6: 3 errors, good length, basic complexity');
             }
             if (totalErrors > 3 || wordCount < 150 || complexityRatio < 5) {
                 // IELTS Band = 5, CELPIP = 6
                 ieltsScore = 5;
                 celpipScore = 6;
                 console.log('⚠️ Band 5: High errors OR short text OR very low complexity');
             }
            
            console.log(`📈 Final scores: IELTS ${ieltsScore}/9, CELPIP ${celpipScore}/12`);
            
            return {
                ielts: ieltsScore,
                celpip: celpipScore,
                baseScore: (ieltsScore / 9) * 100,
                totalErrors: totalErrors,
                errorBreakdown: {
                    grammar: grammarCount,
                    spelling: spellingCount,
                    punctuation: punctuationCount,
                    style: styleCount
                }
            };
        }

        // Calculate simplified IELTS and CELPIP scores from metrics
        function calculateSimplifiedScores(metrics) {
            // Ensure metrics exist and have required properties
            if (!metrics || typeof metrics !== 'object') {
                console.warn('⚠️ Invalid metrics object for score calculation, using defaults');
                metrics = {
                    errorRate: 0,
                    severityLevels: { high: 0, medium: 0, low: 0 },
                    totalWords: 100,
                    avgWordsPerSentence: 15,
                    complexityRatio: 10
                };
            }
            
            const { 
                errorRate = 0, 
                severityLevels = { high: 0, medium: 0, low: 0 }, 
                totalWords = 100, 
                avgWordsPerSentence = 15, 
                complexityRatio = 10 
            } = metrics;
            
            // Base score calculation
            let baseScore = 9; // Start with perfect IELTS score
            
            // Deduct based on error rate
            if (errorRate > 15) baseScore -= 4;
            else if (errorRate > 10) baseScore -= 3;
            else if (errorRate > 5) baseScore -= 2;
            else if (errorRate > 2) baseScore -= 1;
            else if (errorRate > 1) baseScore -= 0.5;
            
            // Adjust based on error severity
            const totalErrors = severityLevels.high + severityLevels.medium + severityLevels.low;
            if (totalErrors > 0) {
                const severityImpact = (severityLevels.high * 0.3 + severityLevels.medium * 0.2 + severityLevels.low * 0.1) / totalErrors;
                baseScore -= severityImpact;
            }
            
            // Adjust for text length (bonus for longer texts)
            if (totalWords >= 300) baseScore += 0.5;
            else if (totalWords < 150) baseScore -= 0.5;
            
            // Adjust for sentence complexity
            if (avgWordsPerSentence < 10) baseScore -= 0.5;
            else if (avgWordsPerSentence > 25) baseScore -= 0.3;
            else if (avgWordsPerSentence >= 15 && avgWordsPerSentence <= 20) baseScore += 0.2;
            
            // Adjust for vocabulary complexity
            if (complexityRatio >= 25) baseScore += 0.3;
            else if (complexityRatio < 10) baseScore -= 0.3;
            
            // Ensure score is within bounds
            // Use custom logic result instead of mathematical calculation
            const celpipScoreAlready = celpipScore; // Use the celpipScore from custom logic above
            
            return {
                ielts: ieltsScore,
                celpip: celpipScore,
                baseScore: baseScore,
                factors: {
                    'Error Rate Impact': errorRate > 2 ? 'Significant deduction' : 'Minimal impact',
                    'Severity Distribution': severityLevels.high > 0 ? 'High-severity errors present' : 'No critical errors',
                    'Text Length': totalWords >= 300 ? 'Length bonus applied' : totalWords < 150 ? 'Length penalty applied' : 'Standard length',
                    'Sentence Complexity': avgWordsPerSentence >= 15 && avgWordsPerSentence <= 20 ? 'Optimal complexity' : 'Room for improvement',
                    'Vocabulary Level': complexityRatio >= 25 ? 'Advanced vocabulary bonus' : 'Consider using more sophisticated words'
                }
            };
        }

        // Local detection completely removed - using API ONLY

        // Detect advanced words
        function detectAdvancedWords(text) {
            const advancedWords = [
                'sophisticated', 'comprehensive', 'fundamental', 'significant', 'considerable', 
                'substantial', 'essential', 'crucial', 'critical', 'vital', 'paramount',
                'exceptional', 'remarkable', 'extraordinary', 'phenomenal', 'unprecedented',
                'innovative', 'revolutionary', 'transformative', 'progressive', 'contemporary',
                'theoretical', 'philosophical', 'psychological', 'technological', 'methodological',
                'analytical', 'systematic', 'strategic', 'tactical', 'practical',
                'intellectual', 'academic', 'scholarly', 'scientific', 'empirical'
            ];

            const words = text.toLowerCase().split(/\s+/);
            const foundAdvanced = [];
            
            words.forEach(word => {
                const cleanWord = word.replace(/[^\w]/g, '');
                if (advancedWords.includes(cleanWord)) {
                    foundAdvanced.push(cleanWord);
                }
            });

            return {
                words: [...new Set(foundAdvanced)], // Remove duplicates
                count: foundAdvanced.length
            };
        }

        // Calculate reading level
        function calculateReadingLevel(avgSentenceLength, advancedWordCount, totalWords) {
            const complexityRatio = (advancedWordCount / totalWords) * 100;
            
            if (avgSentenceLength > 20 && complexityRatio > 30) return 'Advanced';
            if (avgSentenceLength > 15 && complexityRatio > 20) return 'Upper Intermediate';
            if (avgSentenceLength > 12 && complexityRatio > 15) return 'Intermediate';
            if (avgSentenceLength > 8 && complexityRatio > 10) return 'Lower Intermediate';
            return 'Beginner';
        }

        // Calculate band scores (custom method)
        function calculateBandScores(analysisResult, basicMetrics) {
            const totalErrors = analysisResult.count;
            const wordCount = basicMetrics.wordCount;
            const complexityRatio = (basicMetrics.advancedWordCount / basicMetrics.wordCount) * 100;
            
            let ieltsScore = 5, celpipScore = 6; // Default values
            
            // Custom band scoring logic
                        if (totalErrors < 2 && wordCount > 150 && complexityRatio > 25) {
                // Band 8 (CELPIP 10): Total Error < 2 AND Word count > 150 AND Complexity > 25%
                ieltsScore = 8;
                celpipScore = 10;
            }
            if (totalErrors === 2 && wordCount > 150 && complexityRatio < 20) {
                // Band 7 (CELPIP 9): Total Error = 2 AND Word count > 150 AND Complexity < 20%
                ieltsScore = 7;
                celpipScore = 9;
             }
             if (totalErrors === 3 && wordCount > 150 && complexityRatio < 15) {
                // Band 6 (CELPIP 8): Total Error = 3 AND Word count > 150 AND Complexity < 15%
                ieltsScore = 6;
                                 celpipScore = 8;
             }
             if (totalErrors > 3 || wordCount < 150 || complexityRatio < 5) {
                // Band 5 (CELPIP 6): Total Error > 3 OR Word count < 150 OR Complexity < 5%
                ieltsScore = 5;
                celpipScore = 6;
            } else {
                             }
            
            return { ielts: ieltsScore, celpip: celpipScore };
        }

        // Update all additional sections
        function updateReadabilitySection() {
            const result = currentAnalysisResult;
            const metrics = result.basicMetrics;
            const readabilityGrid = document.getElementById('readability-grid');
            
            if (!readabilityGrid) return;
            
            readabilityGrid.innerHTML = `
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-book"></i>
                        Reading Level
                    </div>
                    <div class="card-value">${result.detailedAnalysis?.readabilityLevel || calculateReadingLevel(metrics.avgSentenceLength, metrics.advancedWordCount, metrics.wordCount)}</div>
                    <div class="card-description">Based on sentence complexity and vocabulary</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-ruler"></i>
                        Text Complexity
                    </div>
                    <div class="card-value">${result.detailedAnalysis ? result.detailedAnalysis.complexityRatio.toFixed(1) : ((metrics.advancedWordCount / metrics.wordCount) * 100).toFixed(1)}%</div>
                    <div class="card-description">Percentage of complex words (6+ characters)</div>
                </div>
            `;
        }

        function updateVocabularySection() {
            const result = currentAnalysisResult;
            const metrics = result.basicMetrics;
            const vocabularyGrid = document.getElementById('vocabulary-grid');
            
            if (!vocabularyGrid) return;
            
            vocabularyGrid.innerHTML = `
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-star"></i>
                        Advanced Words
                    </div>
                    <div class="card-value">${metrics.advancedWordCount}</div>
                    <div class="card-description">Sophisticated vocabulary used</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-percentage"></i>
                        Vocabulary Density
                    </div>
                    <div class="card-value">${((metrics.advancedWordCount / metrics.wordCount) * 100).toFixed(1)}%</div>
                    <div class="card-description">Advanced words per total words</div>
                </div>
            `;
        }

        function updateSentenceStructureSection() {
            const result = currentAnalysisResult;
            const metrics = result.basicMetrics;
            const sentenceGrid = document.getElementById('sentence-grid');
            
            if (!sentenceGrid) return;
            
            sentenceGrid.innerHTML = `
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-list-ol"></i>
                        Total Sentences
                    </div>
                    <div class="card-value">${metrics.sentenceCount}</div>
                    <div class="card-description">Number of sentences in your text</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-ruler-horizontal"></i>
                        Average Length
                    </div>
                    <div class="card-value">${metrics.avgSentenceLength}</div>
                    <div class="card-description">Words per sentence (optimal: 15-20)</div>
                </div>
            `;
        }

        function updateErrorRatesSection() {
            const result = currentAnalysisResult;
            const errorRatesGrid = document.getElementById('error-rates-grid');
            
            if (!errorRatesGrid) return;
            
            const detailedAnalysis = result.detailedAnalysis;
            
            errorRatesGrid.innerHTML = `
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Overall Error Rate
                    </div>
                    <div class="card-value">${detailedAnalysis ? detailedAnalysis.errorRate.toFixed(2) : ((result.count / result.basicMetrics.wordCount) * 100).toFixed(2)}</div>
                    <div class="card-description">Errors per 100 words</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-spell-check"></i>
                        Grammar Error Rate
                    </div>
                    <div class="card-value">${detailedAnalysis ? detailedAnalysis.grammarErrorRate.toFixed(2) : (((result.errorCategories?.Grammar?.length || 0) / result.basicMetrics.wordCount) * 100).toFixed(2)}</div>
                    <div class="card-description">Grammar errors per 100 words</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-font"></i>
                        Spelling Error Rate
                    </div>
                    <div class="card-value">${detailedAnalysis ? detailedAnalysis.spellingErrorRate.toFixed(2) : (((result.errorCategories?.Spelling?.length || 0) / result.basicMetrics.wordCount) * 100).toFixed(2)}</div>
                    <div class="card-description">Spelling errors per 100 words</div>
                </div>
            `;
        }

        function updateSeverityAnalysisSection() {
            const result = currentAnalysisResult;
            const severityGrid = document.getElementById('severity-grid');
            
            if (!severityGrid) return;
            
            const severityLevels = result.severityLevels || { high: 0, medium: 0, low: 0 };
            
            severityGrid.innerHTML = `
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
                        High Severity
                    </div>
                    <div class="card-value">${severityLevels.high}</div>
                    <div class="card-description">Critical issues requiring immediate attention</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                        Medium Severity
                    </div>
                    <div class="card-value">${severityLevels.medium}</div>
                    <div class="card-description">Important issues affecting readability</div>
                </div>
                <div class="analysis-card">
                    <div class="card-title">
                        <i class="fas fa-info-circle" style="color: #17a2b8;"></i>
                        Low Severity
                    </div>
                    <div class="card-value">${severityLevels.low}</div>
                    <div class="card-description">Minor style and formatting suggestions</div>
                </div>
            `;
        }

        function updateCategoryDistributionSection() {
            const result = currentAnalysisResult;
            const categoryGrid = document.getElementById('category-grid');
            
            if (!categoryGrid) return;
            
            const categories = result.errorCategories || {};
            let categoryCards = '';
            
            Object.entries(categories).forEach(([category, errors]) => {
                if (errors.length > 0) {
                    categoryCards += `
                        <div class="analysis-card">
                            <div class="card-title">
                                <i class="fas fa-${getCategoryIcon(category)}"></i>
                                ${category}
                            </div>
                            <div class="card-value">${errors.length}</div>
                            <div class="card-description">${category.toLowerCase()} issues found</div>
                        </div>
                    `;
                }
            });
            
            if (categoryCards === '') {
                categoryCards = `
                    <div class="analysis-card">
                        <div class="card-title">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            No Issues Found
                        </div>
                        <div class="card-value">0</div>
                        <div class="card-description">Excellent writing quality!</div>
                    </div>
                `;
            }
            
            categoryGrid.innerHTML = categoryCards;
        }

        function updateAPIResponseSection() {
            const result = currentAnalysisResult;
            const apiData = document.getElementById('api-data');
            
            if (!apiData) return;
            
            if (result.apiData) {
                apiData.innerHTML = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;">
                        <pre>${JSON.stringify(result.apiData, null, 2)}</pre>
                    </div>
                    <p style="margin-top: 1rem; color: #666;">
                        <strong>Source:</strong> ${result.source}<br>
                        <strong>Total Matches:</strong> ${result.apiData.matches?.length || 0}<br>
                        <strong>Language:</strong> ${result.apiData.language?.name || 'Unknown'}
                    </p>
                `;
            } else {
                apiData.innerHTML = `
                    <p><strong>Analysis Source:</strong> ${result.source}</p>
                    <p>Raw Ga Server data not available for local analysis.</p>
                `;
            }
        }

        function updateRuleMatchesSection() {
            const result = currentAnalysisResult;
            const ruleMatchesDetails = document.getElementById('rule-matches-details');
            
            if (!ruleMatchesDetails) return;
            
            if (result.detailedErrors && result.detailedErrors.length > 0) {
                let rulesHtml = '';
                result.detailedErrors.forEach((error, index) => {
                    rulesHtml += `
                        <div class="error-category">
                            <div class="category-header">
                                <div class="category-name">Rule ${index + 1}: ${error.rule?.id || 'Unknown'}</div>
                                <div class="category-count">${error.rule?.issueType || 'N/A'}</div>
                            </div>
                            <div style="padding: 0.8rem;">
                                <p><strong>Message:</strong> ${error.message}</p>
                                <p><strong>Context:</strong> "${error.context?.text || ''}"</p>
                                ${error.replacements ? `<p><strong>Suggestions:</strong> ${error.replacements.slice(0, 3).map(r => r.value).join(', ')}</p>` : ''}
                                ${error.rule?.urls ? `<p><strong>Learn More:</strong> <a href="${error.rule.urls[0]?.value}" target="_blank">Grammar Guide</a></p>` : ''}
                            </div>
                        </div>
                    `;
                });
                ruleMatchesDetails.innerHTML = rulesHtml;
            } else {
                ruleMatchesDetails.innerHTML = `
                    <div class="error-category">
                        <div style="padding: 1rem; text-align: center; color: #28a745; font-weight: 600;">
                            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                            No detailed rule matches available. This indicates excellent writing quality!
                        </div>
                    </div>
                `;
            }
        }

        function updateSuggestionsSection() {
            const result = currentAnalysisResult;
            const suggestionsDetails = document.getElementById('suggestions-details');
            
            if (!suggestionsDetails) return;
            
            let allSuggestions = [];
            
            // Collect all suggestions from error categories
            Object.values(result.errorCategories || {}).forEach(categoryErrors => {
                categoryErrors.forEach(error => {
                    if (error.suggestions && error.suggestions.length > 0) {
                        allSuggestions.push({
                            original: error.context || error.message,
                            suggestions: error.suggestions,
                            message: error.message
                        });
                    }
                });
            });
            
            if (allSuggestions.length > 0) {
                let suggestionsHtml = '';
                allSuggestions.forEach((item, index) => {
                    suggestionsHtml += `
                        <div class="error-category">
                            <div class="category-header">
                                <div class="category-name">Suggestion ${index + 1}</div>
                                <div class="category-count">${item.suggestions.length}</div>
                            </div>
                            <div style="padding: 0.8rem;">
                                <p><strong>Issue:</strong> ${item.message}</p>
                                <p><strong>Original:</strong> "${item.original}"</p>
                                <p><strong>Suggestions:</strong> ${item.suggestions.join(', ')}</p>
                            </div>
                        </div>
                    `;
                });
                suggestionsDetails.innerHTML = suggestionsHtml;
            } else {
                suggestionsDetails.innerHTML = `
                    <div class="error-category">
                        <div style="padding: 1rem; text-align: center; color: #28a745; font-weight: 600;">
                            <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                            No correction suggestions needed. Your writing is excellent!
                        </div>
                    </div>
                `;
            }
        }

        function updateImprovementAreasSection() {
            const result = currentAnalysisResult;
            const improvementContent = document.getElementById('improvement-content');
            
            if (!improvementContent) return;
            
            let improvements = [];
            
            // Analyze error patterns to suggest improvements
            const errorCategories = result.errorCategories || {};
            const metrics = result.basicMetrics;
            
            // Check for major error categories
            if (errorCategories.Grammar && errorCategories.Grammar.length > 0) {
                improvements.push({
                    priority: 'High',
                    area: 'Grammar Structure',
                    suggestion: `Focus on grammar fundamentals. You have ${errorCategories.Grammar.length} grammar issues that need attention.`,
                    tips: 'Review subject-verb agreement, verb tenses, and sentence structure.'
                });
            }
            
            if (errorCategories.Spelling && errorCategories.Spelling.length > 0) {
                improvements.push({
                    priority: 'High',
                    area: 'Spelling Accuracy',
                    suggestion: `Improve spelling consistency. Found ${errorCategories.Spelling.length} spelling errors.`,
                    tips: 'Use spell-check tools and practice commonly misspelled words.'
                });
            }
            
            if (metrics.avgSentenceLength < 10) {
                improvements.push({
                    priority: 'Medium',
                    area: 'Sentence Length',
                    suggestion: 'Your sentences are quite short. Try combining related ideas for better flow.',
                    tips: 'Aim for 15-20 words per sentence for optimal readability.'
                });
            } else if (metrics.avgSentenceLength > 25) {
                improvements.push({
                    priority: 'Medium',
                    area: 'Sentence Complexity',
                    suggestion: 'Some sentences are very long. Consider breaking them into shorter, clearer statements.',
                    tips: 'Long sentences can confuse readers. Aim for clarity over complexity.'
                });
            }
            
            if (((metrics.advancedWordCount / metrics.wordCount) * 100) < 15) {
                improvements.push({
                    priority: 'Low',
                    area: 'Vocabulary Enhancement',
                    suggestion: 'Consider using more sophisticated vocabulary to enhance your writing.',
                    tips: 'Replace simple words with more precise, academic alternatives when appropriate.'
                });
            }
            
            if (improvements.length === 0) {
                improvements.push({
                    priority: 'None',
                    area: 'Excellent Writing',
                    suggestion: 'Your writing demonstrates high quality across all areas!',
                    tips: 'Continue practicing to maintain this excellent standard.'
                });
            }
            
            let improvementHtml = '';
            improvements.forEach(item => {
                const priorityColor = item.priority === 'High' ? '#dc3545' : 
                                    item.priority === 'Medium' ? '#ffc107' : 
                                    item.priority === 'Low' ? '#17a2b8' : '#28a745';
                
                improvementHtml += `
                    <div class="feedback-category">
                        <h4 style="color: ${priorityColor};">
                            <i class="fas fa-flag"></i> ${item.priority} Priority: ${item.area}
                        </h4>
                        <p><strong>Recommendation:</strong> ${item.suggestion}</p>
                        <p><strong>Tips:</strong> ${item.tips}</p>
                    </div>
                `;
            });
            
            improvementContent.innerHTML = improvementHtml;
        }

        function updateWritingTipsSection() {
            const result = currentAnalysisResult;
            const tipsContent = document.getElementById('tips-content');
            
            if (!tipsContent) return;
            
            const tips = [
                {
                    category: 'Grammar',
                    icon: 'spell-check',
                    tip: 'Read your writing aloud to catch grammar mistakes your eyes might miss.'
                },
                {
                    category: 'Vocabulary',
                    icon: 'book',
                    tip: 'Use a thesaurus to find more precise words, but ensure you understand their meanings.'
                },
                {
                    category: 'Structure',
                    icon: 'list-ol',
                    tip: 'Vary your sentence length and structure to create engaging, readable text.'
                },
                {
                    category: 'Clarity',
                    icon: 'eye',
                    tip: 'After writing, ask yourself: "Would someone unfamiliar with this topic understand?"'
                },
                {
                    category: 'Proofreading',
                    icon: 'search',
                    tip: 'Take a break before proofreading. Fresh eyes catch more errors.'
                }
            ];
            
            let tipsHtml = '';
            tips.forEach(item => {
                tipsHtml += `
                    <div class="feedback-category">
                        <h4>
                            <i class="fas fa-${item.icon}"></i> ${item.category}
                        </h4>
                        <p>${item.tip}</p>
                    </div>
                `;
            });
            
            tipsContent.innerHTML = tipsHtml;
        }

        function updateScoreFactorsSection() {
            const result = currentAnalysisResult;
            const scoreFactorsContent = document.getElementById('score-factors-content');
            
            if (!scoreFactorsContent) return;
            
            const scores = result.scores || calculateBandScores(result, result.basicMetrics);
            
            let factorsHtml = `
                <div class="feedback-category">
                    <h4><i class="fas fa-calculator"></i> Score Calculation</h4>
                    <p><strong>IELTS Score: ${scores.ielts}/9</strong></p>
                    <p><strong>CLB Score: ${scores.clb}/12</strong></p>
                </div>
            `;
            
            if (result.scores && result.scores.factors) {
                factorsHtml += `
                    <div class="feedback-category">
                        <h4><i class="fas fa-list-ul"></i> Factors Affecting Your Score</h4>
                `;
                Object.entries(result.scores.factors).forEach(([factor, impact]) => {
                    factorsHtml += `<p><strong>${factor}:</strong> ${impact}</p>`;
                });
                factorsHtml += `</div>`;
            } else {
                factorsHtml += `
                    <div class="feedback-category">
                        <h4><i class="fas fa-info-circle"></i> Key Scoring Factors</h4>
                        <p><strong>Error Rate:</strong> Lower error rates result in higher scores</p>
                        <p><strong>Text Length:</strong> 300+ words provide more comprehensive assessment</p>
                        <p><strong>Vocabulary:</strong> Advanced word usage increases scores</p>
                        <p><strong>Sentence Structure:</strong> Varied, well-constructed sentences score higher</p>
                        <p><strong>Grammar Accuracy:</strong> Correct grammar is essential for high scores</p>
                    </div>
                `;
            }
            
            scoreFactorsContent.innerHTML = factorsHtml;
        }

        // Helper functions for offline analysis
        
        function calculateAverageSyllables(words) {
            if (words.length === 0) return 0;
            
            let totalSyllables = 0;
            words.forEach(word => {
                // Simple syllable estimation
                const syllableCount = word.toLowerCase()
                    .replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '')
                    .replace(/^y/, '')
                    .match(/[aeiouy]{1,2}/g);
                totalSyllables += syllableCount ? syllableCount.length : 1;
            });
            
            return totalSyllables / words.length;
        }
        
        function detectAdvancedVocabulary(words) {
            const advancedWords = [
                // Academic and sophisticated vocabulary
                'comprehensive', 'fundamental', 'significant', 'substantial', 'demonstrate',
                'establish', 'analyze', 'synthesize', 'phenomenon', 'paradigm',
                'sophisticated', 'meticulous', 'eloquent', 'articulate', 'proficient',
                'exemplary', 'innovative', 'strategic', 'systematic', 'methodology',
                'contemporary', 'conventional', 'inevitable', 'preliminary', 'subsequent',
                'furthermore', 'nevertheless', 'consequently', 'moreover', 'therefore',
                'nonetheless', 'accordingly', 'conversely', 'specifically', 'particularly',
                'approximately', 'predominantly', 'substantially', 'considerably', 'extensively'
            ];
            
            return words.filter(word => 
                advancedWords.includes(word.toLowerCase()) || 
                (word.length > 8 && /^[a-z]+$/.test(word.toLowerCase()))
            );
        }
        
        function getReadabilityLevel(score) {
            if (score >= 90) return 'Very Easy';
            if (score >= 80) return 'Easy';
            if (score >= 70) return 'Fairly Easy';
            if (score >= 60) return 'Standard';
            if (score >= 50) return 'Fairly Difficult';
            if (score >= 30) return 'Difficult';
            return 'Very Difficult';
        }
        
        function calculateComplexityRatio(words) {
            if (words.length === 0) return 0;
            const complexWords = words.filter(word => word.length > 6);
            return parseFloat(((complexWords.length / words.length) * 100).toFixed(1));
        }
        
        function calculateRepetitionScore(words) {
            if (words.length === 0) return 0;
            const wordCounts = {};
            words.forEach(word => {
                const lowered = word.toLowerCase();
                wordCounts[lowered] = (wordCounts[lowered] || 0) + 1;
            });
            
            const repeatedWords = Object.values(wordCounts).filter(count => count > 1);
            return parseFloat(((repeatedWords.length / words.length) * 100).toFixed(1));
        }
        
        function calculateCohesionScore(sentences) {
            if (sentences.length === 0) return 0;
            
            // Simple cohesion indicators
            const cohesiveDevices = ['however', 'therefore', 'furthermore', 'moreover', 'consequently', 'additionally', 'meanwhile', 'subsequently'];
            let cohesionCount = 0;
            
            sentences.forEach(sentence => {
                const words = sentence.toLowerCase().split(/\s+/);
                cohesiveDevices.forEach(device => {
                    if (words.includes(device)) cohesionCount++;
                });
            });
            
            return parseFloat(((cohesionCount / sentences.length) * 100).toFixed(1));
        }
        
        function calculateOfflineScores(wordCount, errorCount, errorCategories, readabilityScore, advancedWordPercentage, averageWordsPerSentence) {
            // Comprehensive scoring algorithm based on multiple factors
            
            // Error rate impact (lower is better)
            const errorRate = wordCount > 0 ? (errorCount / wordCount) * 100 : 0;
            const grammarErrorWeight = errorCategories['Grammar'] * 3; // Grammar errors are more significant
            const spellingErrorWeight = errorCategories['Spelling'] * 2;
            const styleErrorWeight = errorCategories['Style'] * 1;
            
            // Vocabulary sophistication (higher is better)
            const vocabularyScore = Math.min(advancedWordPercentage * 2, 100);
            
            // Sentence complexity (moderate complexity is better)
            let sentenceComplexityScore = 100;
            if (averageWordsPerSentence < 10) {
                sentenceComplexityScore = 60; // Too simple
            } else if (averageWordsPerSentence > 25) {
                sentenceComplexityScore = 70; // Too complex
            }
            
            // Readability (60-70 is ideal for most writing)
            let readabilityScoreAdjusted = 100;
            if (readabilityScore < 30) {
                readabilityScoreAdjusted = 40; // Very difficult
            } else if (readabilityScore > 80) {
                readabilityScoreAdjusted = 70; // Too simple
            }
            
            // Word count consideration
            let lengthScore = 100;
            if (wordCount < 150) {
                lengthScore = 60; // Too short for comprehensive assessment
            } else if (wordCount > 500) {
                lengthScore = 90; // Good length
            }
            
            // Calculate base score (0-100)
            const baseScore = Math.max(0, 100 - 
                (grammarErrorWeight + spellingErrorWeight + styleErrorWeight) - 
                Math.max(0, errorRate - 2) * 5 // Allow up to 2% error rate
            );
            
            // Use custom scoring logic instead of mathematical calculation
            const enhancedScore = (ielts / 9) * 100;
            
            // Use ONLY custom logic - no mathematical overrides
            let ielts = 5, celpip = 6; // Default values
            
            // Custom band scoring logic with separate if statements
            if (totalErrors < 2 && wordCount > 150 && complexityRatio > 25) {
                // IELTS Band = 8, CELPIP = 10
                ielts = 8;
                celpip = 10;
            }
            if (totalErrors === 2 && wordCount > 150 && complexityRatio < 20) {
                // IELTS Band = 7, CELPIP = 9
                ielts = 7;
                celpip = 9;
            }
            if (totalErrors === 3 && wordCount > 150 && complexityRatio < 15) {
                // IELTS Band = 6, CELPIP = 8
                ielts = 6;
                celpip = 8;
            }
            if (totalErrors > 3 || wordCount < 150 || complexityRatio < 5) {
                // IELTS Band = 5, CELPIP = 6
                ielts = 5;
                celpip = 6;
            }
            
            return {
                ielts: ielts,
                celpip: celpip,
                baseScore: parseFloat(((ielts / 9) * 100).toFixed(1)),
                factors: {
                    errorRate: parseFloat((errorCount / wordCount * 100).toFixed(2)),
                    vocabularyScore: parseFloat((advancedWordPercentage || 20).toFixed(1)),
                    sentenceComplexityScore: parseFloat((averageWordsPerSentence || 15).toFixed(1)),
                    readabilityScore: parseFloat((readabilityScore || 50).toFixed(1)),
                    lengthScore: parseFloat((wordCount > 150 ? 100 : (wordCount / 150) * 100).toFixed(1))
                }
            };
        }

        // Test function for Open Source LanguageTool API
        function testAPI() {
            console.log('🧪 Testing Open Source LanguageTool API...');
            
            // Test with a text that has various error types
            const testText = "This are a test sentense with some erors. I would of written better, but theirs many grammer mistakes here.";
            
            console.log('📝 Test text:', testText);
            console.log('🌐 Testing Open Source LanguageTool API (api.languagetool.org)');
            console.log('⚠️ NO FALLBACKS - Server errors will be shown directly');
            console.log('⏰ Started at:', new Date().toISOString());
            
            const startTime = Date.now();
            
            detectGrammarErrors(testText)
                .then(result => {
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    console.log('✅ Open Source LanguageTool API Test Successful in', duration, 'ms');
                    console.log('📊 Full result object:', result);
                    
                    const errorCount = result.count || 0;
                    const source = result.source || 'Unknown';
                    const categories = Object.keys(result.errorCategories || {}).filter(cat => result.errorCategories[cat] > 0);
                    const analysisData = result.detailedAnalysis;
                    const scores = result.scores;
                    
                    let successMessage = `✅ Open Source LanguageTool API is working perfectly!\n\n`;
                    successMessage += `📊 Analysis Source: ${source}\n`;
                    successMessage += `🐛 Errors Found: ${errorCount}\n`;
                    successMessage += `🔍 Error Categories: ${categories.join(', ')}\n`;
                    successMessage += `⏱️ API Response Time: ${duration}ms\n\n`;
                    
                    if (analysisData) {
                        successMessage += `📈 Writing Metrics:\n`;
                        successMessage += `• Word Count: ${analysisData.wordCount}\n`;
                        successMessage += `• Readability: ${analysisData.readabilityLevel}\n`;
                        successMessage += `• Advanced Words: ${analysisData.advancedWordCount}\n`;
                        successMessage += `• Avg Sentence Length: ${analysisData.averageWordsPerSentence}\n\n`;
                    }
                    
                    if (scores) {
                        successMessage += `🎯 Scoring:\n`;
                        successMessage += `• IELTS Band: ${scores.ielts}\n`;
                        successMessage += `• CLB Level: ${scores.clb}\n`;
                        successMessage += `• Base Score: ${scores.baseScore}%\n\n`;
                    }
                    
                    successMessage += `🎉 Open Source LanguageTool API is connected!\n`;
                    successMessage += `🌍 Using professional grammar checking\n`;
                    successMessage += `📡 Direct API connection established`;
                    
                    alert(successMessage);
                })
                .catch(error => {
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    console.error('❌ Open Source LanguageTool API Test Failed after', duration, 'ms');
                    console.error('📋 Full error:', error);
                    
                    let errorMessage = `❌ Open Source LanguageTool API test failed!\n\n`;
                    errorMessage += `🔍 Server Error: ${error.message}\n`;
                    errorMessage += `⏱️ Failed after: ${duration}ms\n\n`;
                    
                    if (error.message.includes('403')) {
                        errorMessage += `🚫 The LanguageTool server is blocking requests from your network.\n`;
                        errorMessage += `This could be due to corporate firewalls or IP restrictions.\n\n`;
                        errorMessage += `💡 Try from a different network (mobile hotspot, home WiFi).`;
                    } else if (error.message.includes('429')) {
                        errorMessage += `⏳ Rate limit exceeded on LanguageTool server.\n`;
                        errorMessage += `The free API has usage limits.\n\n`;
                        errorMessage += `💡 Wait a few minutes and try again.`;
                    } else if (error.message.includes('500')) {
                        errorMessage += `🔧 LanguageTool server internal error.\n`;
                        errorMessage += `The server is experiencing technical issues.\n\n`;
                        errorMessage += `💡 Try again later - this is a server-side problem.`;
                    } else if (error.message.includes('Network Error')) {
                        errorMessage += `🌐 Cannot connect to LanguageTool server.\n`;
                        errorMessage += `Check your internet connection.\n\n`;
                        errorMessage += `💡 Verify internet connectivity and try again.`;
                    } else {
                        errorMessage += `📋 Unexpected server error.\n`;
                        errorMessage += `Check browser console (F12) for technical details.`;
                    }
                    
                    showErrorModal(errorMessage);
                });
        }

        // Add test button (for debugging)
        window.testAPI = testAPI;

        // Calculate bands using ONLY Analysis Summary displayed values
        function calculateBandsFromAnalysisSummary() {
            const result = currentAnalysisResult;
            const metrics = result.basicMetrics;
            
            // Extract the EXACT values displayed in Analysis Summary
            const wordCount = metrics.wordCount;                                    // Word Count shown
            const totalErrors = result.count;                                       // Total Errors shown  
            const complexityPercentage = result.detailedAnalysis.complexityRatio;   // Advanced Words % shown
            
            console.log('📊 ANALYSIS SUMMARY VALUES:');
            console.log('   Word Count:', wordCount);
            console.log('   Total Errors:', totalErrors);
            console.log('   Complexity %:', complexityPercentage);
            
            let ieltsScore, clbScore;
            
            // Apply user's updated CLB logic using Analysis Summary values
            if (totalErrors === 0 && wordCount >= 150 && complexityPercentage >= 50) {
                ieltsScore = 9;
                clbScore = 10;
                console.log('✅ BAND 9: Total Errors = 0, Word Count >= 150, Complexity >= 50%');
            }
            else if (totalErrors === 0 && wordCount >= 150 && complexityPercentage >= 35) {
                ieltsScore = 8;
                clbScore = 10;
                console.log('✅ BAND 8: Total Errors = 0, Word Count >= 150, Complexity >= 35%');
            }
            else if (totalErrors < 2 && wordCount >= 150 && complexityPercentage >= 30) {
                ieltsScore = 7.5;
                clbScore = 10;
                console.log('✅ BAND 7.5: Total Errors < 2, Word Count >= 150, Complexity >= 30%');
            }
            else if (totalErrors < 2 && wordCount >= 150 && complexityPercentage >= 25) {
                ieltsScore = 7;
                clbScore = 9;
                console.log('✅ BAND 7: Total Errors < 2, Word Count >= 150, Complexity >= 25%');
            }
            else if (totalErrors < 2 && wordCount >= 150 && complexityPercentage < 25) {
                ieltsScore = 6.5;
                clbScore = 8;
                console.log('✅ BAND 6.5: Total Errors < 2, Word Count >= 150, Complexity < 25%');
            }
            else if (totalErrors === 2 && wordCount >= 150) {
                ieltsScore = 6.5;
                clbScore = 8;
                console.log('✅ BAND 6.5: Total Errors = 2, Word Count >= 150');
            }
            else if (totalErrors === 3 && wordCount >= 150) {
                ieltsScore = 6;
                clbScore = 7;
                console.log('✅ BAND 6: Total Errors = 3, Word Count >= 150');
            }
            else if (totalErrors > 3 && wordCount >= 150) {
                ieltsScore = 5.5;
                clbScore = 6;
                console.log('✅ BAND 5.5: Total Errors > 3, Word Count >= 150');
            }
            else if (wordCount >= 100 && wordCount <= 149) {
                ieltsScore = 5.5;
                clbScore = 6;
                console.log('✅ BAND 5.5: Word Count between 100-149');
            }
            else if (wordCount >= 0 && wordCount < 100) {
                ieltsScore = 4;
                clbScore = 4;
                console.log('✅ BAND 4: Word Count between 0-99');
            }
            else {
                ieltsScore = "Analyse Summary";
                clbScore = "Analyse Summary";
                console.log('🔍 ANALYSE SUMMARY: Conditions do not match standard band criteria');
            }
            
            console.log('🎯 FINAL BANDS FROM ANALYSIS SUMMARY: IELTS =', ieltsScore, ', CLB =', clbScore);
            
            return {
                ielts: ieltsScore,
                clb: clbScore,
                source: 'Analysis Summary Values'
            };
        }

    </script>
</body>
</html> 