<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS General Speaking Part 1 - Family & Friends | GK Foundation</title>

    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Century Gothic', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(139, 69, 19, 0.2) 50%, rgba(255, 215, 0, 0.1) 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.05) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }

        /* Header spacing */
        .header-spacer {
            height: 20px;
            width: 100%;
        }

        /* Guruvammal Logo as Back Button - Right Side */
        .gk-logo-container {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .gk-logo-container:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        /* Master Guruvammal Logo for template back button */
        .master-guruvammal-logo {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            box-sizing: border-box;
            font-family: 'Century Gothic', sans-serif;
            font-size: 26px;
            font-weight: 900;
            letter-spacing: -1px;
            line-height: 1;
            color: #5d3a0a;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(139, 69, 19, 0.25) 50%, rgba(205, 133, 63, 0.2) 100%);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3), 0 0 40px rgba(212, 175, 55, 0.2);
            z-index: 10000;
            transition: all 0.3s ease;
        }

        .master-guruvammal-logo .musical-corner {
            position: absolute;
            top: 3px;
            right: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: transparent;
            border: 1px solid #5d3a0a;
            color: #5d3a0a;
            font-family: 'Century Gothic', sans-serif;
            font-size: 7px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
            box-shadow: none;
        }

        .master-guruvammal-logo:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.4), 0 0 50px rgba(212, 175, 55, 0.3);
        }

        .back-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #8b4513;
            font-family: 'Century Gothic', sans-serif;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            text-align: center;
            transition: all 0.3s ease;
        }

        .gk-logo-container:hover .back-label {
            color: #5d3a0a;
            transform: translateY(-1px);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            margin-left: 360px;
            transition: margin-left 0.3s ease;
        }

        .container.menu-collapsed {
            margin-left: 20px;
        }

        /* Main Content */
        .main-content {
            margin-top: 0;
            padding: 1.5rem 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Slide-out Menu Button */
        .menu-toggle {
            position: fixed;
            top: 30px;
            left: 360px;
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 0.8rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            z-index: 1001;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .menu-toggle.collapsed {
            left: 20px;
        }

        .menu-toggle:hover {
            background: linear-gradient(135deg, #a0522d, #8b4513);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
        }

        .menu-toggle-label {
            position: fixed;
            top: 85px;
            left: 382px;
            background: rgba(139, 69, 19, 0.9);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.3);
            z-index: 1001;
            transition: all 0.3s ease;
            min-width: 45px;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .menu-toggle-label.collapsed {
            left: 42px;
        }

        /* Slide-out Menu */
        .slide-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 350px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(20px);
            box-shadow: 4px 0 24px rgba(212, 175, 55, 0.15);
            border-right: 2px solid rgba(212, 175, 55, 0.15);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding-top: 20px;
        }

        .slide-menu::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.02) 0%, rgba(212, 175, 55, 0.03) 100%);
            z-index: 0;
            pointer-events: none;
        }

        .slide-menu.collapsed {
            left: -350px;
        }

        .menu-header {
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            padding: 2rem 1.5rem 1.2rem 1.5rem;
            text-align: center;
            position: relative;
            z-index: 2;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 70px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        .menu-bookmark-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .menu-subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .menu-content {
            padding: 1.5rem 0;
            position: relative;
            z-index: 2;
        }

        .menu-item {
            display: block;
            padding: 0.8rem 1.5rem;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-left-color: #d4af37;
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(139, 69, 19, 0.1);
            border-left-color: #8b4513;
            font-weight: 600;
        }

        /* Hero Section */
        .hero-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.2);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            color: #8b4513;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .hero-description {
            font-size: 1rem;
            color: #555;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Content Sections */
        .content-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .section-title {
            font-size: 1.6rem;
            color: #8b4513;
            margin-bottom: 1rem;
            font-weight: 700;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 0.5rem;
        }

        /* Speaking Practice Interface */
        .speaking-interface {
            display: block;
            margin: 2rem 0;
        }

        .questions-panel {
            background: rgba(255, 255, 255, 0.8);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .recording-panel {
            background: rgba(255, 255, 255, 0.8);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .question-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(139, 69, 19, 0.05);
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }

        .question-number {
            font-weight: 700;
            color: #8b4513;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .question-text {
            color: #333;
            font-size: 1rem;
            line-height: 1.5;
        }

        .question-tips {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        /* Question Audio Controls */
        .question-audio {
            margin-top: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .play-question-btn {
            padding: 0.4rem 0.8rem;
            background: linear-gradient(135deg, #8b4513, #d4af37);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            min-width: 80px;
            justify-content: center;
        }

        .play-question-btn:hover {
            background: linear-gradient(135deg, #a0522d, #ffd700);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
        }

        .play-question-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .play-question-btn.playing {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            animation: pulse-play 1s infinite;
        }

        @keyframes pulse-play {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .audio-status {
            font-size: 0.7rem;
            color: #8b4513;
            font-weight: 500;
        }

        /* Auto Play Controls */
        .auto-play-section {
            background: rgba(139, 69, 19, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .auto-play-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .auto-play-btn {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            color: #8b4513;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .auto-play-btn:hover {
            background: linear-gradient(135deg, #ffd700, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .auto-play-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auto-play-status {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        /* Recording Controls */
        .recording-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .recording-status {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
        }

        .recording-status.idle {
            background: rgba(200, 200, 200, 0.1);
            border-color: #ccc;
            color: #666;
        }

        .recording-status.recording {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff0000;
            color: #cc0000;
            animation: pulse 1s infinite;
        }

        .recording-status.recorded {
            background: rgba(0, 128, 0, 0.1);
            border-color: #008000;
            color: #006600;
        }

        .recording-status.processing {
            background: rgba(255, 165, 0, 0.1);
            border-color: #ffa500;
            color: #cc8400;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .record-btn {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .record-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
        }

        .stop-btn {
            background: linear-gradient(135deg, #666, #444);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 102, 102, 0.3);
        }

        .stop-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 102, 102, 0.4);
        }

        .play-btn {
            background: linear-gradient(135deg, #44aa44, #006600);
            color: white;
            box-shadow: 0 4px 15px rgba(68, 170, 68, 0.3);
        }

        .play-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(68, 170, 68, 0.4);
        }

        .process-btn {
            background: linear-gradient(135deg, #ffa500, #cc8400);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
        }

        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.4);
        }



        /* Timer Display */
        .timer-display {
            font-size: 1.2rem;
            font-weight: 700;
            color: #8b4513;
            margin: 1rem 0;
            text-align: center;
        }

        /* Audio Waveform Visualization */
        .audio-visualizer {
            width: 100%;
            height: 100px;
            background: rgba(139, 69, 19, 0.05);
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .visualizer-bars {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 60px;
        }

        .visualizer-bar {
            width: 3px;
            background: linear-gradient(to top, #d4af37, #8b4513);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        /* Instructions Section */
        .instructions {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .instructions h3 {
            color: #8b4513;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .instructions ul {
            padding-left: 1.5rem;
        }

        .instructions li {
            margin-bottom: 0.5rem;
            color: #555;
            line-height: 1.5;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                margin-left: 20px;
            }

            .container.menu-collapsed {
                margin-left: 20px;
            }

            .slide-menu {
                width: 100%;
                left: -100%;
            }

            .speaking-interface {
                margin: 1rem 0;
            }

            .hero-title {
                font-size: 1.8rem;
            }

            .control-buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .control-btn {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 1rem;
            }

            .hero-title {
                font-size: 1.5rem;
            }

            .content-section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header-spacer"></div>

    <!-- Guruvammal Logo Container (Back Button) -->
    <div class="gk-logo-container" onclick="handleBackButton()">
        <div class="master-guruvammal-logo">
                            Ga<span class="musical-corner">P</span>
        </div>
        <div class="back-label">Back</div>
    </div>

    <!-- Slide-out Menu Toggle Button -->
    <button class="menu-toggle" onclick="toggleMenu()" id="menuToggle">
        ›
    </button>
    <div class="menu-toggle-label" id="menuToggleLabel">Collapse</div>

    <!-- Slide-out Menu -->
    <div class="slide-menu" id="slideMenu">
        <div class="menu-header">
            <div class="menu-bookmark-title">IELTS Speaking Part 1</div>
            <div class="menu-subtitle">Family & Friends</div>
        </div>
        <div class="menu-content">
            <div class="menu-item" onclick="scrollToSection('instructions')">📋 Instructions</div>
            <div class="menu-item active" onclick="scrollToSection('recording')">🎙️ Recording Studio</div>
            <div class="menu-item" onclick="scrollToSection('analysis')">📊 Analysis Results</div>
            <div class="menu-item" onclick="scrollToSection('guidance')">🎯 Band Score Guidance</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container" id="container">
        <main class="main-content">
            <!-- Hero Section -->
            <section class="hero-section">
                <h1 class="hero-title">IELTS Speaking Part 1</h1>
                <div class="hero-subtitle">Family & Friends Practice</div>
                <p class="hero-description">
                    Practice answering common Part 1 questions about your family relationships and friendships. Record your responses and get automated feedback to improve your speaking skills and achieve your target band score.
                </p>
            </section>

            <!-- Instructions Section -->
            <section class="instructions" id="instructions-section">
                <h3>🎯 How to Practice</h3>
                <ul>
                    <li><strong>Read each question carefully</strong> - Take time to understand what's being asked</li>
                    <li><strong>Think before speaking</strong> - You have a moment to organize your thoughts</li>
                    <li><strong>Speak naturally</strong> - Answer in 20-30 seconds with 2-3 sentences per question</li>
                    <li><strong>Record your response</strong> - Click record, answer the question, then stop</li>
                    <li><strong>Review and improve</strong> - Listen to your original recording and review the analysis feedback</li>
                    <li><strong>Next Question</strong> - After analysis, click "Next Question" to automatically move to the next practice question</li>
                    <li><strong>Retry</strong> - Click "Retry" to practice the same question again with a fresh recording session</li>
                    <li><strong>Practice regularly</strong> - Consistency is key to improving your speaking fluency</li>
                </ul>
            </section>

            <!-- Speaking Practice Interface -->
            <section class="content-section" id="recording-section">
                <h2 class="section-title">🗣️ Speaking Practice Session</h2>
                
                <div class="speaking-interface">
                    <!-- Recording Panel -->
                    <div class="recording-panel">
                        <h3 style="color: #8b4513; margin-bottom: 1rem;">Recording Studio</h3>
                        
                        <!-- Recording Status -->
                        <div class="recording-status idle" id="recordingStatus">
                            Ready to record your response
                        </div>

                        <!-- Timer Display -->
                        <div class="timer-display" id="timerDisplay">00:00</div>

                        <!-- Audio Visualizer -->
                        <div class="audio-visualizer" id="audioVisualizer">
                            <div class="visualizer-bars" id="visualizerBars">
                                <!-- Bars will be generated dynamically -->
                            </div>
                        </div>

                        <!-- Question Selection for Analysis -->
                        <div style="margin: 1rem 0; text-align: center;">
                            <label for="questionSelect" style="color: #8b4513; font-weight: 600; margin-bottom: 0.5rem; display: block;">Which question are you answering?</label>
                            <select id="questionSelect" onchange="updateCurrentQuestion()" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #d4af37; font-size: 0.9rem; width: 100%; max-width: 700px; margin: 0 auto; display: block;">
                                <option value="1">Q1: How many people are in your family?</option>
                                <option value="2">Q2: Who are you closest to in your family?</option>
                                <option value="3">Q3: How often do you see your friends?</option>
                                <option value="4">Q4: What do you like doing with your friends?</option>
                                <option value="5">Q5: Do you prefer spending time with family or friends?</option>
                                <option value="6">Q6: How do you keep in touch with old friends?</option>
                            </select>
                        </div>

                        <!-- Control Buttons -->
                        <div class="control-buttons">
                            <button class="control-btn record-btn" id="recordBtn" onclick="startRecording()">
                                🎤 Start Recording
                            </button>
                            <button class="control-btn stop-btn" id="stopBtn" onclick="stopRecording()" disabled>
                                ⏹️ Stop Recording
                            </button>
                            <button class="control-btn play-btn" id="playBtn" onclick="playOriginal()" disabled>
                                ▶️ Play Original
                            </button>
                            <button class="control-btn process-btn" id="processBtn" onclick="processAudio()" disabled>
                                🔄 Submit for Analysis
                            </button>
                        </div>
                    </div>
                </div> 
                <!-- Analysis Results Section -->
                <div id="analysisSection" style="display: none;">
                    <div class="content-section">
                        <h2 class="section-title">📊 Analysis & Improvement</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
                            <!-- What You Said -->
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.3);">
                                <h3 style="color: #8b4513; margin-bottom: 1rem;">📝 What You Said</h3>
                                <div id="transcriptResult" style="background: rgba(139, 69, 19, 0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid #d4af37; font-style: italic; line-height: 1.6;"></div>
                            </div>

                            <!-- Analysis & Missing Elements -->
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.3);">
                                <h3 style="color: #8b4513; margin-bottom: 1rem;">🎯 Analysis & What You Missed</h3>
                                <div id="analysisResult" style="line-height: 1.6;"></div>
                            </div>
                        </div>

                        <!-- Improved Response -->
                        <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 10px; border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 2rem;">
                            <h3 style="color: #8b4513; margin-bottom: 1rem;">✨ Improved Response Suggestions</h3>
                            <div id="improvedResponse" style="background: rgba(212, 175, 55, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #8b4513; font-weight: 500; line-height: 1.6;"></div>
                        </div>

                        <!-- Band Score Comparison -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div style="background: rgba(255, 0, 0, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #ff6666;">
                                <h4 style="color: #cc0000; margin-bottom: 0.5rem;">Your Current Response</h4>
                                <div id="currentBandScore" style="font-size: 1.1rem; font-weight: 600;"></div>
                            </div>
                            <div style="background: rgba(0, 128, 0, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid #66cc66;">
                                <h4 style="color: #006600; margin-bottom: 0.5rem;">Potential with Improvements</h4>
                                <div id="improvedBandScore" style="font-size: 1.1rem; font-weight: 600;"></div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 2rem; padding: 1.5rem;">
                            <button onclick="goToNextQuestion()" style="
                                background: linear-gradient(135deg, #27ae60, #229954);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 25px;
                                font-size: 1rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                min-width: 150px;
                                box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(39, 174, 96, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(39, 174, 96, 0.3)'">
                                ➡️ Next Question
                            </button>
                            <button onclick="refreshCurrentQuestion()" style="
                                background: linear-gradient(135deg, #3498db, #2980b9);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 25px;
                                font-size: 1rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                min-width: 150px;
                                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.3)'">
                                🔄 Retry
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Band Score Guidance -->
            <section class="content-section" id="guidance-section">
                <h2 class="section-title">🎯 IELTS Band Score Guidance</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                    <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid #ffd700; border-radius: 10px; padding: 1rem;">
                        <h4 style="color: #8b4513; margin-bottom: 0.5rem;">🥇 Band 7-9 (Target)</h4>
                        <ul style="color: #666; font-size: 0.9rem; line-height: 1.5; padding-left: 1rem;">
                            <li>Speak fluently with natural rhythm</li>
                            <li>Use varied vocabulary appropriately</li>
                            <li>Demonstrate complex grammar structures</li>
                            <li>Clear pronunciation with correct stress</li>
                            <li>Extend answers with examples and reasons</li>
                        </ul>
                    </div>
                    <div style="background: rgba(212, 175, 55, 0.1); border: 1px solid #d4af37; border-radius: 10px; padding: 1rem;">
                        <h4 style="color: #8b4513; margin-bottom: 0.5rem;">🎯 Family & Friends Tips</h4>
                        <ul style="color: #666; font-size: 0.9rem; line-height: 1.5; padding-left: 1rem;">
                            <li>Be specific about relationships and activities</li>
                            <li>Use relationship vocabulary accurately</li>
                            <li>Express emotions about people you care about</li>
                            <li>Compare different types of relationships</li>
                            <li>Give examples of shared experiences</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Global variables for audio recording
        let mediaRecorder;
        let audioChunks = [];
        let originalAudioBlob = null;
        let refinedAudioBlob = null;
        let isRecording = false;
        let recordingTimer;
        let recordingSeconds = 0;
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let animationFrameId;

        // Global variables for question audio playback
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isPlayingQuestion = false;
        let currentQuestionIndex = 0;
        let autoPlayActive = false;

        // Question texts for audio playback (Family & Friends)
        const questions = [
            "How many people are in your family?",
            "Who are you closest to in your family?", 
            "How often do you see your friends?",
            "What do you like doing with your friends?",
            "Do you prefer spending time with family or friends?",
            "How do you keep in touch with old friends?"
        ];

        // IELTS Part 1 Family & Friends - Ideal Response Patterns
        const idealResponsePatterns = {
            1: { // How many people are in your family?
                keyElements: ["family size", "family members", "living arrangement"],
                sampleResponse: "There are [number] people in my family: my [family members]. We [living situation]. My family is quite [size description].",
                bandCriteria: {
                    fluency: "Clear enumeration of family members",
                    lexical: "Family relationship vocabulary",
                    grammar: "Correct use of 'there are/is'",
                    pronunciation: "Clear family member terms"
                }
            },
            2: { // Who are you closest to in your family?
                keyElements: ["specific person", "reason for closeness", "shared activities/interests"],
                sampleResponse: "I'm closest to my [family member] because [reason]. We [shared activities/interests]. [He/She] always [specific example of closeness].",
                bandCriteria: {
                    fluency: "Emotional expression with natural delivery",
                    lexical: "Emotional vocabulary, relationship descriptors",
                    grammar: "Comparative structures, present simple",
                    pronunciation: "Emotional intonation and clarity"
                }
            },
            3: { // How often do you see your friends?
                keyElements: ["frequency", "types of meetings", "reason for frequency"],
                sampleResponse: "I see my friends [frequency] because [reason]. We usually [meeting types/activities]. It depends on [factors affecting frequency] but generally [typical pattern].",
                bandCriteria: {
                    fluency: "Natural use of time expressions",
                    lexical: "Frequency adverbs, social activity vocabulary",
                    grammar: "Present simple, frequency expressions",
                    pronunciation: "Clear time and frequency expressions"
                }
            },
            4: { // What do you like doing with your friends?
                keyElements: ["specific activities", "reasons for enjoyment", "examples"],
                sampleResponse: "I really enjoy [activities] with my friends because [reasons]. For example, [specific example]. We also like to [another activity] when [circumstance].",
                bandCriteria: {
                    fluency: "Enthusiastic delivery with good flow",
                    lexical: "Activity vocabulary, enjoyment expressions",
                    grammar: "Present simple, like/enjoy + gerund",
                    pronunciation: "Enthusiastic intonation"
                }
            },
            5: { // Do you prefer spending time with family or friends?
                keyElements: ["clear preference", "comparison", "reasons for preference"],
                sampleResponse: "I prefer spending time with [family/friends] because [specific reasons]. With [chosen group], I can [benefits], whereas with [other group] it's more [different characteristics]. Both are important, but [final reasoning].",
                bandCriteria: {
                    fluency: "Clear comparison and preference expression",
                    lexical: "Comparative language, preference vocabulary",
                    grammar: "Comparative structures, preference expressions",
                    pronunciation: "Clear contrast in delivery"
                }
            },
            6: { // How do you keep in touch with old friends?
                keyElements: ["communication methods", "frequency", "types of contact"],
                sampleResponse: "I keep in touch with old friends through [methods]. We [frequency and type of contact] and I find [preferred method] works best because [reason]. Sometimes we [special occasions contact].",
                bandCriteria: {
                    fluency: "Natural discussion of modern communication",
                    lexical: "Communication technology vocabulary",
                    grammar: "Present simple, communication expressions",
                    pronunciation: "Clear technology-related terms"
                }
            }
        };

        // Analysis variables
        let currentQuestionBeingAnswered = 1;
        let analysisResult = null;

        // Initialize audio visualizer
        function initializeVisualizer() {
            const visualizerBars = document.getElementById('visualizerBars');
            for (let i = 0; i < 30; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '5px';
                visualizerBars.appendChild(bar);
            }
        }

        // Update visualizer during recording
        function updateVisualizer() {
            if (!analyser || !isRecording) return;
            
            analyser.getByteFrequencyData(dataArray);
            const bars = document.querySelectorAll('.visualizer-bar');
            
            for (let i = 0; i < bars.length; i++) {
                const barHeight = (dataArray[i] / 255) * 60 + 5;
                bars[i].style.height = `${barHeight}px`;
            }
            
            if (isRecording) {
                animationFrameId = requestAnimationFrame(updateVisualizer);
            }
        }

        // Start recording function
        async function startRecording() {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                // Set up audio context for visualization
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // Set up MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = function() {
                    originalAudioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    updateUI('recorded');
                };
                
                // Start recording
                mediaRecorder.start();
                isRecording = true;
                recordingSeconds = 0;
                
                // Start timer
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    updateTimerDisplay();
                }, 1000);
                
                // Update UI and start visualization
                updateUI('recording');
                updateVisualizer();
                
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Could not access microphone. Please check your permissions and try again.');
            }
        }

        // Stop recording function
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                clearInterval(recordingTimer);
                cancelAnimationFrame(animationFrameId);
                
                // Reset visualizer bars
                const bars = document.querySelectorAll('.visualizer-bar');
                bars.forEach(bar => bar.style.height = '5px');
            }
        }

        // Play original recording
        function playOriginal() {
            if (originalAudioBlob) {
                const audioUrl = URL.createObjectURL(originalAudioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                
                // Update status during playback
                updateRecordingStatus('Playing original recording...');
                audio.addEventListener('ended', () => {
                    updateRecordingStatus('Original recording finished');
                    setTimeout(() => updateRecordingStatus('Ready to record your next response'), 2000);
                });
            }
        }

        // Audio Processing with Speech-to-Text Analysis
        async function processAudio() {
            if (!originalAudioBlob) return;
            
            updateUI('processing');
            updateRecordingStatus('System is analyzing your response...');
            
            try {
                // Step 1: Convert speech to text
                updateRecordingStatus('Converting speech to text...');
                const transcript = await speechToText(originalAudioBlob);
                
                // Step 2: Analyze response against IELTS criteria
                updateRecordingStatus('Analyzing IELTS performance...');
                analysisResult = await analyzeIELTSResponse(transcript, currentQuestionBeingAnswered);
                
                // Step 3: Generate improved response
                updateRecordingStatus('Generating improved response...');
                const improvedText = generateImprovedResponse(transcript, analysisResult, currentQuestionBeingAnswered);
                
                // Step 4: Display analysis results
                displayAnalysisResults(transcript, analysisResult, improvedText);
                
                updateRecordingStatus('Analysis complete! Review the feedback below.');
                
                // Show analysis section
                document.getElementById('analysisSection').style.display = 'block';
                document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Processing Error:', error);
                updateRecordingStatus('Error during analysis. Please try again.');
                // Fallback to mock processing
                await mockProcessAudio();
            }
        }

        // Mock Speech-to-Text (Replace with real API)
        async function speechToText(audioBlob) {
            // Simulate API processing time
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // For demo, return mock transcripts based on selected question
            const mockTranscripts = {
                1: "There are four people in my family - my parents, my younger sister, and myself.",
                2: "I'm closest to my mother because we share similar interests and she always supports me.",
                3: "I see my friends quite often, usually on weekends and sometimes during the week for coffee.",
                4: "I enjoy going to movies, having dinner together, and playing sports with my friends.",
                5: "I prefer spending time with friends because we can relate to each other's experiences better.",
                6: "I keep in touch with old friends through social media, WhatsApp, and occasional video calls."
            };
            
            return mockTranscripts[currentQuestionBeingAnswered] || "I need to think about my family and friends.";
        }

        // IELTS Response Analysis Engine (adapted for Family & Friends)
        async function analyzeIELTSResponse(transcript, questionNumber) {
            // Simulate analysis processing
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const idealPattern = idealResponsePatterns[questionNumber];
            const analysis = {
                questionNumber: questionNumber,
                transcript: transcript,
                wordCount: transcript.split(' ').length,
                missingElements: [],
                strengths: [],
                improvements: [],
                bandScores: {
                    fluency: 0,
                    lexical: 0,
                    grammar: 0,
                    pronunciation: 0,
                    overall: 0
                }
            };

            // Analyze missing key elements
            idealPattern.keyElements.forEach(element => {
                if (!checkElementPresent(transcript, element, questionNumber)) {
                    analysis.missingElements.push(element);
                }
            });

            // Assess response quality
            analysis.strengths = assessStrengths(transcript, questionNumber);
            analysis.improvements = generateImprovements(transcript, analysis.missingElements, questionNumber);
            analysis.bandScores = calculateBandScores(transcript, analysis.missingElements, questionNumber);

            return analysis;
        }

        // Check if key elements are present in response (Family & Friends specific)
        function checkElementPresent(transcript, element, questionNumber) {
            const lowerTranscript = transcript.toLowerCase();
            
            switch(questionNumber) {
                case 1: // Family size
                    if (element === "family size") return /\d/.test(lowerTranscript) || lowerTranscript.includes("many") || lowerTranscript.includes("few");
                    if (element === "family members") return lowerTranscript.includes("mother") || lowerTranscript.includes("father") || lowerTranscript.includes("sister") || lowerTranscript.includes("brother") || lowerTranscript.includes("parents");
                    return lowerTranscript.split(' ').length > 6;
                case 2: // Closest family member
                    if (element === "specific person") return lowerTranscript.includes("mother") || lowerTranscript.includes("father") || lowerTranscript.includes("sister") || lowerTranscript.includes("brother") || lowerTranscript.includes("closest");
                    if (element === "reason for closeness") return lowerTranscript.includes("because") || lowerTranscript.includes("since");
                    return lowerTranscript.split(' ').length > 8;
                case 3: // Friend frequency
                    if (element === "frequency") return lowerTranscript.includes("often") || lowerTranscript.includes("usually") || lowerTranscript.includes("sometimes") || lowerTranscript.includes("every");
                    if (element === "types of meetings") return lowerTranscript.includes("meet") || lowerTranscript.includes("see") || lowerTranscript.includes("hang out");
                    return lowerTranscript.split(' ').length > 6;
                case 4: // Activities with friends
                    if (element === "specific activities") return lowerTranscript.includes("go") || lowerTranscript.includes("play") || lowerTranscript.includes("watch") || lowerTranscript.includes("eat") || lowerTranscript.includes("do");
                    if (element === "reasons for enjoyment") return lowerTranscript.includes("enjoy") || lowerTranscript.includes("like") || lowerTranscript.includes("love") || lowerTranscript.includes("fun");
                    return lowerTranscript.split(' ').length > 8;
                case 5: // Family vs friends preference
                    if (element === "clear preference") return lowerTranscript.includes("prefer") || lowerTranscript.includes("like") || lowerTranscript.includes("better");
                    if (element === "comparison") return lowerTranscript.includes("family") && lowerTranscript.includes("friends");
                    return lowerTranscript.split(' ').length > 8;
                case 6: // Keeping in touch
                    if (element === "communication methods") return lowerTranscript.includes("phone") || lowerTranscript.includes("text") || lowerTranscript.includes("social media") || lowerTranscript.includes("call") || lowerTranscript.includes("message");
                    if (element === "frequency") return lowerTranscript.includes("often") || lowerTranscript.includes("sometimes") || lowerTranscript.includes("regularly");
                    return lowerTranscript.split(' ').length > 6;
                default:
                    return true;
            }
        }

        // Assess response strengths (Family & Friends specific)
        function assessStrengths(transcript, questionNumber) {
            const strengths = [];
            const wordCount = transcript.split(' ').length;
            
            if (wordCount >= 15) strengths.push("Good length - adequate detail provided");
            if (transcript.includes("because") || transcript.includes("since")) strengths.push("Good use of reasoning");
            if (transcript.includes("really") || transcript.includes("very") || transcript.includes("quite")) strengths.push("Good use of intensifiers");
            if (transcript.split('.').length > 1) strengths.push("Multiple sentences used");
            if (transcript.includes("family") || transcript.includes("friends")) strengths.push("On-topic vocabulary used");
            
            return strengths;
        }

        // Generate improvement suggestions (Family & Friends specific)
        function generateImprovements(transcript, missingElements, questionNumber) {
            const improvements = [];
            
            missingElements.forEach(missing => {
                switch(missing) {
                    case "family size":
                        improvements.push("Include specific numbers of family members");
                        break;
                    case "family members":
                        improvements.push("Name specific family relationships (parents, siblings, etc.)");
                        break;
                    case "specific person":
                        improvements.push("Identify which family member you're closest to");
                        break;
                    case "reason for closeness":
                        improvements.push("Explain why you're close to that person using 'because'");
                        break;
                    case "frequency":
                        improvements.push("Use specific time expressions (daily, weekly, monthly)");
                        break;
                    case "specific activities":
                        improvements.push("Name concrete activities you do together");
                        break;
                    case "communication methods":
                        improvements.push("Mention specific ways you communicate (calls, texts, social media)");
                        break;
                    case "clear preference":
                        improvements.push("State your preference clearly using 'I prefer...'");
                        break;
                    case "comparison":
                        improvements.push("Compare both family and friends to explain your choice");
                        break;
                    default:
                        improvements.push(`Include ${missing} in your response`);
                }
            });

            if (transcript.split(' ').length < 12) {
                improvements.push("Extend your answer - aim for 20-30 seconds (2-3 sentences)");
            }

            if (!transcript.includes("because") && !transcript.includes("since")) {
                improvements.push("Add reasons using 'because' or 'since' to explain your answers");
            }

            return improvements;
        }

        // Calculate IELTS band scores (Family & Friends specific)
        function calculateBandScores(transcript, missingElements, questionNumber) {
            const wordCount = transcript.split(' ').length;
            const hasReasoning = transcript.includes("because") || transcript.includes("since");
            const hasRelationshipVocab = transcript.includes("family") || transcript.includes("friends") || transcript.includes("mother") || transcript.includes("father");
            const missingCount = missingElements.length;
            
            let fluency = 5.5; // Base score
            let lexical = 5.5;
            let grammar = 5.5;
            let pronunciation = 6; // Assume good pronunciation from audio

            // Adjust based on response quality
            if (wordCount >= 20) fluency += 0.5;
            if (wordCount >= 30) fluency += 0.5;
            if (hasReasoning) {
                fluency += 0.5;
                lexical += 0.5;
                grammar += 0.5;
            }
            if (hasRelationshipVocab) {
                lexical += 0.5;
            }
            if (missingCount === 0) {
                fluency += 1;
                lexical += 0.5;
                grammar += 0.5;
            }
            if (missingCount >= 2) {
                fluency -= 1;
                lexical -= 0.5;
            }

            // Cap at 9.0
            fluency = Math.min(9, Math.max(4, fluency));
            lexical = Math.min(9, Math.max(4, lexical));
            grammar = Math.min(9, Math.max(4, grammar));
            
            const overall = (fluency + lexical + grammar + pronunciation) / 4;

            return {
                fluency: Math.round(fluency * 2) / 2,
                lexical: Math.round(lexical * 2) / 2,
                grammar: Math.round(grammar * 2) / 2,
                pronunciation: Math.round(pronunciation * 2) / 2,
                overall: Math.round(overall * 2) / 2
            };
        }

        // Generate improved response (Family & Friends specific)
        function generateImprovedResponse(originalTranscript, analysis, questionNumber) {
            const idealPattern = idealResponsePatterns[questionNumber];
            let improvedResponse = originalTranscript;

            // If response is too short or missing key elements, create enhanced version
            if (analysis.missingElements.length > 0 || analysis.wordCount < 15) {
                // Generate template-based improved response
                const templates = {
                    1: "There are [number] people in my family: my [parents/family members]. We [live together/live separately]. My family is quite [close/large/small] and we [family characteristic].",
                    2: "I'm closest to my [family member] because [specific reason]. We [shared activities] and [he/she] always [supportive behavior]. I feel comfortable talking to [him/her] about [topics].",
                    3: "I see my friends [frequency] because [reason]. We usually [meeting activities] and sometimes [other activities]. It depends on [factors] but generally we [typical pattern].",
                    4: "I really enjoy [activities] with my friends because [reasons]. For example, we often [specific example] and it's always [feeling]. We also like to [another activity] when [circumstance].",
                    5: "I prefer spending time with [family/friends] because [specific reasons]. With [chosen group], I can [benefits], whereas with [other group] it's more [different characteristics]. Both are important, but [final reasoning].",
                    6: "I keep in touch with old friends mainly through [communication methods]. We [frequency and type of contact] and I find [preferred method] works best because [reason]. Sometimes we [special occasions contact]."
                };
                
                improvedResponse = templates[questionNumber] || idealPattern.sampleResponse;
            }

            return improvedResponse;
        }

        // Display analysis results
        function displayAnalysisResults(transcript, analysis, improvedText) {
            // Display transcript
            document.getElementById('transcriptResult').textContent = `"${transcript}"`;

            // Display analysis
            const analysisDiv = document.getElementById('analysisResult');
            let analysisHTML = '';

            if (analysis.strengths.length > 0) {
                analysisHTML += '<div style="color: #006600; margin-bottom: 1rem;"><strong>✅ Strengths:</strong><ul>';
                analysis.strengths.forEach(strength => {
                    analysisHTML += `<li style="margin: 0.3rem 0;">${strength}</li>`;
                });
                analysisHTML += '</ul></div>';
            }

            if (analysis.missingElements.length > 0) {
                analysisHTML += '<div style="color: #cc6600; margin-bottom: 1rem;"><strong>⚠️ Missing Elements:</strong><ul>';
                analysis.missingElements.forEach(missing => {
                    analysisHTML += `<li style="margin: 0.3rem 0;">You could add: ${missing}</li>`;
                });
                analysisHTML += '</ul></div>';
            }

            if (analysis.improvements.length > 0) {
                analysisHTML += '<div style="color: #0066cc;"><strong>💡 Improvements:</strong><ul>';
                analysis.improvements.forEach(improvement => {
                    analysisHTML += `<li style="margin: 0.3rem 0;">${improvement}</li>`;
                });
                analysisHTML += '</ul></div>';
            }

            analysisDiv.innerHTML = analysisHTML;

            // Display improved response
            document.getElementById('improvedResponse').textContent = `"${improvedText}"`;

            // Display band scores
            const currentScores = analysis.bandScores;
            const improvedScores = {
                fluency: Math.min(9, currentScores.fluency + 1),
                lexical: Math.min(9, currentScores.lexical + 1),
                grammar: Math.min(9, currentScores.grammar + 0.5),
                pronunciation: currentScores.pronunciation,
                overall: 0
            };
            improvedScores.overall = (improvedScores.fluency + improvedScores.lexical + improvedScores.grammar + improvedScores.pronunciation) / 4;
            improvedScores.overall = Math.round(improvedScores.overall * 2) / 2;

            document.getElementById('currentBandScore').innerHTML = `
                <div>Overall: ${currentScores.overall}</div>
                <small>Fluency: ${currentScores.fluency} | Lexical: ${currentScores.lexical} | Grammar: ${currentScores.grammar} | Pronunciation: ${currentScores.pronunciation}</small>
            `;

            document.getElementById('improvedBandScore').innerHTML = `
                <div>Overall: ${improvedScores.overall}</div>
                <small>Fluency: ${improvedScores.fluency} | Lexical: ${improvedScores.lexical} | Grammar: ${improvedScores.grammar} | Pronunciation: ${improvedScores.pronunciation}</small>
            `;
        }

        // Update current question for analysis
        function updateCurrentQuestion() {
            currentQuestionBeingAnswered = parseInt(document.getElementById('questionSelect').value);
            console.log('Selected question:', currentQuestionBeingAnswered);
        }

        // Fallback mock processing
        async function mockProcessAudio() {
            await new Promise(resolve => setTimeout(resolve, 2000));
            updateRecordingStatus('Mock processing complete!');
        }

        // Update UI based on current state
        function updateUI(state) {
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const playBtn = document.getElementById('playBtn');
            const processBtn = document.getElementById('processBtn');
            
            // Reset all buttons
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            playBtn.disabled = true;
            processBtn.disabled = true;
            
            switch(state) {
                case 'recording':
                    recordBtn.disabled = true;
                    stopBtn.disabled = false;
                    updateRecordingStatus('Recording... Speak clearly into your microphone');
                    break;
                case 'recorded':
                    playBtn.disabled = false;
                    processBtn.disabled = false;
                    updateRecordingStatus('Recording complete! You can play it back or submit for analysis');
                    break;
                case 'processing':
                    recordBtn.disabled = true;
                    playBtn.disabled = true;
                    processBtn.disabled = true;
                    updateRecordingStatus('System is analyzing and improving your recording...');
                    break;
                case 'idle':
                default:
                    updateRecordingStatus('Ready to record your response');
                    break;
            }
        }

        // Update recording status display
        function updateRecordingStatus(message) {
            const statusElement = document.getElementById('recordingStatus');
            statusElement.textContent = message;
            
            // Update status styling based on content
            statusElement.className = 'recording-status';
            if (message.includes('Recording')) {
                statusElement.classList.add('recording');
            } else if (message.includes('complete') || message.includes('finished') || message.includes('ready')) {
                statusElement.classList.add('recorded');
            } else if (message.includes('Processing') || message.includes('analyzing')) {
                statusElement.classList.add('processing');
            } else {
                statusElement.classList.add('idle');
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = timeString;
        }

        // Menu toggle functionality
        function toggleMenu() {
            const menu = document.getElementById('slideMenu');
            const container = document.getElementById('container');
            const toggleBtn = document.getElementById('menuToggle');
            const toggleLabel = document.getElementById('menuToggleLabel');
            
            if (menu.classList.contains('collapsed')) {
                menu.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleLabel.classList.remove('collapsed');
                container.classList.remove('menu-collapsed');
                toggleBtn.innerHTML = '›';
                toggleLabel.textContent = 'Collapse';
            } else {
                menu.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleLabel.classList.add('collapsed');
                container.classList.add('menu-collapsed');
                toggleBtn.innerHTML = '‹';
                toggleLabel.textContent = 'Expand';
            }
        }

        // Back button functionality (MANDATORY)
        function handleBackButton() {
            console.log('🔄 Back button clicked from IELTS Speaking Part 1 - Going to Speaking Introduction');
            window.location.href = 'IELTS_General_Speaking_Introduction.html';
        }

        // Navigation Functions for Analysis Results
        function goToNextQuestion() {
            // Get current question number
            const currentQuestion = parseInt(document.getElementById('questionSelect').value);
            
            // Calculate next question (cycle back to 1 if we're at question 6)
            const nextQuestion = currentQuestion >= 6 ? 1 : currentQuestion + 1;
            
            // Store the next question in URL parameters and reload
            const url = new URL(window.location);
            url.searchParams.set('question', nextQuestion);
            window.location.href = url.toString();
        }

        function refreshCurrentQuestion() {
            // Get current question number
            const currentQuestion = parseInt(document.getElementById('questionSelect').value);
            
            // Store the current question in URL parameters and reload
            const url = new URL(window.location);
            url.searchParams.set('question', currentQuestion);
            window.location.href = url.toString();
        }

        // Function to set question from URL parameters on page load
        function setQuestionFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const questionParam = urlParams.get('question');
            
            if (questionParam) {
                const questionNumber = parseInt(questionParam);
                if (questionNumber >= 1 && questionNumber <= 6) {
                    document.getElementById('questionSelect').value = questionNumber;
                    currentQuestionBeingAnswered = questionNumber;
                    console.log('🎯 Set question from URL:', questionNumber);
                    
                    // Scroll to the recording section after setting the question
                    setTimeout(() => {
                        const recordingSection = document.querySelector('.recording-panel');
                        if (recordingSection) {
                            recordingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 500);
                }
            }
        }

        // Slide-out Menu Navigation Functions
        function scrollToSection(sectionId) {
            let targetElement;
            
            switch(sectionId) {
                case 'instructions':
                    targetElement = document.getElementById('instructions-section');
                    break;
                case 'recording':
                    targetElement = document.getElementById('recording-section');
                    break;
                case 'analysis':
                    targetElement = document.getElementById('analysisSection');
                    break;
                case 'guidance':
                    targetElement = document.getElementById('guidance-section');
                    break;
                default:
                    console.log('Section not found:', sectionId);
                    return;
            }
            
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                updateActiveMenuItem(sectionId);
            }
        }

        function updateActiveMenuItem(activeSection) {
            // Remove active class from all menu items
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            
            // Add active class to the current section's menu item
            const sectionMap = {
                'instructions': '📋 Instructions',
                'recording': '🎙️ Recording Studio',
                'analysis': '📊 Analysis Results',
                'guidance': '🎯 Band Score Guidance'
            };
            
            if (sectionMap[activeSection]) {
                const activeItem = Array.from(menuItems).find(item => 
                    item.textContent.includes(sectionMap[activeSection])
                );
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🎤 IELTS Speaking Part 1 - Family & Friends page loaded');
            initializeVisualizer();
            
            // Set question from URL if provided
            setQuestionFromURL();
            
            // Set initial UI state
            updateUI('idle');
            
            // Check for audio support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateRecordingStatus('Audio recording not supported in this browser');
                document.getElementById('recordBtn').disabled = true;
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (isRecording) {
                stopRecording();
            }
        });
    </script>
</body>
</html> 